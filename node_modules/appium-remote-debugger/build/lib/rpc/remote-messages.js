"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.RemoteMessages = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _protocol = _interopRequireDefault(require("../protocol"));

const OBJECT_GROUP = 'console';
const MINIMAL_COMMAND = 'getMinimalCommand';
const FULL_COMMAND = 'getFullCommand';
const DIRECT_COMMAND = 'getDirectCommand';
const COMMANDS = {
  'Page.getCookies': FULL_COMMAND,
  'Page.navigate': FULL_COMMAND,
  'Runtime.awaitPromise': FULL_COMMAND,
  'Runtime.callFunctionOn': FULL_COMMAND,
  'Runtime.evaluate': FULL_COMMAND,
  'Target.exists': DIRECT_COMMAND,
  'Timeline.start': FULL_COMMAND,
  'Timeline.stop': FULL_COMMAND
};

class RemoteMessages {
  constructor(isTargetBased = false) {
    this.isTargetBased = isTargetBased;
  }

  set isTargetBased(isTargetBased) {
    this._isTargetBased = isTargetBased;
  }

  get isTargetBased() {
    return this._isTargetBased;
  }

  setConnectionKey(connId) {
    return {
      __argument: {
        WIRConnectionIdentifierKey: connId
      },
      __selector: '_rpc_reportIdentifier:'
    };
  }

  connectToApp(connId, appIdKey) {
    return {
      __argument: {
        WIRConnectionIdentifierKey: connId,
        WIRApplicationIdentifierKey: appIdKey
      },
      __selector: '_rpc_forwardGetListing:'
    };
  }

  setSenderKey(connId, senderId, appIdKey, pageIdKey) {
    return {
      __argument: {
        WIRApplicationIdentifierKey: appIdKey,
        WIRConnectionIdentifierKey: connId,
        WIRSenderKey: senderId,
        WIRPageIdentifierKey: pageIdKey,
        WIRAutomaticallyPause: false
      },
      __selector: '_rpc_forwardSocketSetup:'
    };
  }

  indicateWebView(connId, appIdKey, pageIdKey, enabled) {
    return {
      __argument: {
        WIRApplicationIdentifierKey: appIdKey,
        WIRIndicateEnabledKey: _lodash.default.isNil(enabled) ? true : enabled,
        WIRConnectionIdentifierKey: connId,
        WIRPageIdentifierKey: pageIdKey
      },
      __selector: '_rpc_forwardIndicateWebView:'
    };
  }

  launchApplication(bundleId) {
    return {
      __argument: {
        WIRApplicationBundleIdentifierKey: bundleId
      },
      __selector: '_rpc_requestApplicationLaunch:'
    };
  }

  getFullCommand(opts = {}) {
    const {
      method,
      params,
      connId,
      senderId,
      appIdKey,
      pageIdKey,
      targetId,
      id
    } = opts;
    let realMethod;
    let realParams;

    if (this.isTargetBased) {
      realMethod = 'Target.sendMessageToTarget';
      realParams = {
        targetId,
        message: JSON.stringify({
          id,
          method,
          params: Object.assign({
            objectGroup: OBJECT_GROUP,
            includeCommandLineAPI: true,
            doNotPauseOnExceptionsAndMuteConsole: false,
            emulateUserGesture: false,
            generatePreview: false,
            saveResult: false
          }, params)
        })
      };
    } else {
      realMethod = method;
      realParams = Object.assign({
        objectGroup: OBJECT_GROUP,
        includeCommandLineAPI: true,
        doNotPauseOnExceptionsAndMuteConsole: false,
        emulateUserGesture: false
      }, params);
    }

    const plist = {
      __argument: {
        WIRSocketDataKey: {
          method: realMethod,
          params: realParams
        },
        WIRConnectionIdentifierKey: connId,
        WIRSenderKey: senderId,
        WIRApplicationIdentifierKey: appIdKey,
        WIRPageIdentifierKey: pageIdKey
      },
      __selector: '_rpc_forwardSocketData:'
    };
    return _lodash.default.omitBy(plist, _lodash.default.isNil);
  }

  getMinimalCommand(opts = {}) {
    const {
      method,
      params,
      connId,
      senderId,
      appIdKey,
      pageIdKey,
      targetId,
      id
    } = opts;
    let realMethod = method;
    let realParams = params;

    if (this.isTargetBased) {
      realMethod = 'Target.sendMessageToTarget';
      realParams = {
        targetId,
        message: JSON.stringify({
          id,
          method,
          params
        })
      };
    }

    const plist = {
      __argument: {
        WIRSocketDataKey: {
          method: realMethod,
          params: realParams
        },
        WIRConnectionIdentifierKey: connId,
        WIRSenderKey: senderId,
        WIRApplicationIdentifierKey: appIdKey,
        WIRPageIdentifierKey: pageIdKey
      },
      __selector: '_rpc_forwardSocketData:'
    };
    return _lodash.default.omitBy(plist, _lodash.default.isNil);
  }

  getDirectCommand(opts = {}) {
    const {
      method,
      params,
      connId,
      senderId,
      appIdKey,
      pageIdKey,
      id
    } = opts;
    const plist = {
      __argument: {
        WIRSocketDataKey: {
          id,
          method,
          params
        },
        WIRConnectionIdentifierKey: connId,
        WIRSenderKey: senderId,
        WIRApplicationIdentifierKey: appIdKey,
        WIRPageIdentifierKey: pageIdKey
      },
      __selector: '_rpc_forwardSocketData:'
    };
    return _lodash.default.omitBy(plist, _lodash.default.isNil);
  }

  getRemoteCommand(command, opts) {
    const {
      id,
      connId,
      appIdKey,
      senderId,
      pageIdKey,
      targetId
    } = opts;

    switch (command) {
      case 'setConnectionKey':
        return this.setConnectionKey(connId);

      case 'indicateWebView':
        return this.indicateWebView(connId, appIdKey, pageIdKey, opts.enabled);

      case 'connectToApp':
        return this.connectToApp(connId, appIdKey);

      case 'setSenderKey':
        return this.setSenderKey(connId, senderId, appIdKey, pageIdKey);

      case 'launchApplication':
        return this.launchApplication(opts.bundleId);
    }

    const builderFunction = COMMANDS[command] || MINIMAL_COMMAND;
    return this[builderFunction]({ ...(0, _protocol.default)(id, command, opts),
      connId,
      appIdKey,
      senderId,
      pageIdKey,
      targetId
    });
  }

}

exports.RemoteMessages = RemoteMessages;
var _default = RemoteMessages;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9ycGMvcmVtb3RlLW1lc3NhZ2VzLmpzIl0sIm5hbWVzIjpbIk9CSkVDVF9HUk9VUCIsIk1JTklNQUxfQ09NTUFORCIsIkZVTExfQ09NTUFORCIsIkRJUkVDVF9DT01NQU5EIiwiQ09NTUFORFMiLCJSZW1vdGVNZXNzYWdlcyIsImNvbnN0cnVjdG9yIiwiaXNUYXJnZXRCYXNlZCIsIl9pc1RhcmdldEJhc2VkIiwic2V0Q29ubmVjdGlvbktleSIsImNvbm5JZCIsIl9fYXJndW1lbnQiLCJXSVJDb25uZWN0aW9uSWRlbnRpZmllcktleSIsIl9fc2VsZWN0b3IiLCJjb25uZWN0VG9BcHAiLCJhcHBJZEtleSIsIldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleSIsInNldFNlbmRlcktleSIsInNlbmRlcklkIiwicGFnZUlkS2V5IiwiV0lSU2VuZGVyS2V5IiwiV0lSUGFnZUlkZW50aWZpZXJLZXkiLCJXSVJBdXRvbWF0aWNhbGx5UGF1c2UiLCJpbmRpY2F0ZVdlYlZpZXciLCJlbmFibGVkIiwiV0lSSW5kaWNhdGVFbmFibGVkS2V5IiwiXyIsImlzTmlsIiwibGF1bmNoQXBwbGljYXRpb24iLCJidW5kbGVJZCIsIldJUkFwcGxpY2F0aW9uQnVuZGxlSWRlbnRpZmllcktleSIsImdldEZ1bGxDb21tYW5kIiwib3B0cyIsIm1ldGhvZCIsInBhcmFtcyIsInRhcmdldElkIiwiaWQiLCJyZWFsTWV0aG9kIiwicmVhbFBhcmFtcyIsIm1lc3NhZ2UiLCJKU09OIiwic3RyaW5naWZ5IiwiT2JqZWN0IiwiYXNzaWduIiwib2JqZWN0R3JvdXAiLCJpbmNsdWRlQ29tbWFuZExpbmVBUEkiLCJkb05vdFBhdXNlT25FeGNlcHRpb25zQW5kTXV0ZUNvbnNvbGUiLCJlbXVsYXRlVXNlckdlc3R1cmUiLCJnZW5lcmF0ZVByZXZpZXciLCJzYXZlUmVzdWx0IiwicGxpc3QiLCJXSVJTb2NrZXREYXRhS2V5Iiwib21pdEJ5IiwiZ2V0TWluaW1hbENvbW1hbmQiLCJnZXREaXJlY3RD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QUFBLFNBTEk7QUFNSmdCLE1BQUFBO0FBTkksUUFPRkgsSUFQSjs7QUFVQSxZQUFRd0IsT0FBUjtBQUNFLFdBQUssa0JBQUw7QUFDRSxlQUFPLEtBQUsvQyxnQkFBTCxDQUFzQkMsTUFBdEIsQ0FBUDs7QUFDRixXQUFLLGlCQUFMO0FBQ0UsZUFBTyxLQUFLYSxlQUFMLENBQXFCYixNQUFyQixFQUE2QkssUUFBN0IsRUFBdUNJLFNBQXZDLEVBQWtEYSxJQUFJLENBQUNSLE9BQXZELENBQVA7O0FBQ0YsV0FBSyxjQUFMO0FBQ0UsZUFBTyxLQUFLVixZQUFMLENBQWtCSixNQUFsQixFQUEwQkssUUFBMUIsQ0FBUDs7QUFDRixXQUFLLGNBQUw7QUFDRSxlQUFPLEtBQUtFLFlBQUwsQ0FBa0JQLE1BQWxCLEVBQTBCUSxRQUExQixFQUFvQ0gsUUFBcEMsRUFBOENJLFNBQTlDLENBQVA7O0FBQ0YsV0FBSyxtQkFBTDtBQUNFLGVBQU8sS0FBS1MsaUJBQUwsQ0FBdUJJLElBQUksQ0FBQ0gsUUFBNUIsQ0FBUDtBQVZKOztBQWNBLFVBQU00QixlQUFlLEdBQUdyRCxRQUFRLENBQUNvRCxPQUFELENBQVIsSUFBcUJ2RCxlQUE3QztBQUNBLFdBQU8sS0FBS3dELGVBQUwsRUFBc0IsRUFDM0IsR0FBRyx1QkFBbUJyQixFQUFuQixFQUF1Qm9CLE9BQXZCLEVBQWdDeEIsSUFBaEMsQ0FEd0I7QUFFM0J0QixNQUFBQSxNQUYyQjtBQUczQkssTUFBQUEsUUFIMkI7QUFJM0JHLE1BQUFBLFFBSjJCO0FBSzNCQyxNQUFBQSxTQUwyQjtBQU0zQmdCLE1BQUFBO0FBTjJCLEtBQXRCLENBQVA7QUFRRDs7QUE5TmtCOzs7ZUFrT045QixjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBnZXRQcm90b2NvbENvbW1hbmQgZnJvbSAnLi4vcHJvdG9jb2wnO1xuXG5cbmNvbnN0IE9CSkVDVF9HUk9VUCA9ICdjb25zb2xlJztcblxuY29uc3QgTUlOSU1BTF9DT01NQU5EID0gJ2dldE1pbmltYWxDb21tYW5kJztcbmNvbnN0IEZVTExfQ09NTUFORCA9ICdnZXRGdWxsQ29tbWFuZCc7XG5jb25zdCBESVJFQ1RfQ09NTUFORCA9ICdnZXREaXJlY3RDb21tYW5kJztcblxuLy8gbWFwcGluZyBvZiBjb21tYW5kcyB0byB0aGUgZnVuY3Rpb24gZm9yIGdldHRpbmcgdGhlIGNvbW1hbmRcbi8vIGRlZmF1bHRzIHRvIGBnZXRNaW5pbWFsQ29tbWFuZGAsIHNvIG5vIG5lZWQgdG8gaGF2ZSB0aG9zZSBsaXN0ZWQgaGVyZVxuY29uc3QgQ09NTUFORFMgPSB7XG4gICdQYWdlLmdldENvb2tpZXMnOiBGVUxMX0NPTU1BTkQsXG4gICdQYWdlLm5hdmlnYXRlJzogRlVMTF9DT01NQU5ELFxuXG4gICdSdW50aW1lLmF3YWl0UHJvbWlzZSc6IEZVTExfQ09NTUFORCxcbiAgJ1J1bnRpbWUuY2FsbEZ1bmN0aW9uT24nOiBGVUxMX0NPTU1BTkQsXG4gICdSdW50aW1lLmV2YWx1YXRlJzogRlVMTF9DT01NQU5ELFxuXG4gICdUYXJnZXQuZXhpc3RzJzogRElSRUNUX0NPTU1BTkQsXG5cbiAgJ1RpbWVsaW5lLnN0YXJ0JzogRlVMTF9DT01NQU5ELFxuICAnVGltZWxpbmUuc3RvcCc6IEZVTExfQ09NTUFORCxcbn07XG5cbmNsYXNzIFJlbW90ZU1lc3NhZ2VzIHtcbiAgY29uc3RydWN0b3IgKGlzVGFyZ2V0QmFzZWQgPSBmYWxzZSkge1xuICAgIHRoaXMuaXNUYXJnZXRCYXNlZCA9IGlzVGFyZ2V0QmFzZWQ7XG4gIH1cblxuICBzZXQgaXNUYXJnZXRCYXNlZCAoaXNUYXJnZXRCYXNlZCkge1xuICAgIHRoaXMuX2lzVGFyZ2V0QmFzZWQgPSBpc1RhcmdldEJhc2VkO1xuICB9XG5cbiAgZ2V0IGlzVGFyZ2V0QmFzZWQgKCkge1xuICAgIHJldHVybiB0aGlzLl9pc1RhcmdldEJhc2VkO1xuICB9XG5cbiAgLypcbiAgICogQ29ubmVjdGlvbiBmdW5jdGlvbnNcbiAgICovXG5cbiAgc2V0Q29ubmVjdGlvbktleSAoY29ubklkKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgV0lSQ29ubmVjdGlvbklkZW50aWZpZXJLZXk6IGNvbm5JZFxuICAgICAgfSxcbiAgICAgIF9fc2VsZWN0b3I6ICdfcnBjX3JlcG9ydElkZW50aWZpZXI6J1xuICAgIH07XG4gIH1cblxuICBjb25uZWN0VG9BcHAgKGNvbm5JZCwgYXBwSWRLZXkpIHtcbiAgICByZXR1cm4ge1xuICAgICAgX19hcmd1bWVudDoge1xuICAgICAgICBXSVJDb25uZWN0aW9uSWRlbnRpZmllcktleTogY29ubklkLFxuICAgICAgICBXSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk6IGFwcElkS2V5XG4gICAgICB9LFxuICAgICAgX19zZWxlY3RvcjogJ19ycGNfZm9yd2FyZEdldExpc3Rpbmc6J1xuICAgIH07XG4gIH1cblxuICBzZXRTZW5kZXJLZXkgKGNvbm5JZCwgc2VuZGVySWQsIGFwcElkS2V5LCBwYWdlSWRLZXkpIHtcbiAgICByZXR1cm4ge1xuICAgICAgX19hcmd1bWVudDoge1xuICAgICAgICBXSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk6IGFwcElkS2V5LFxuICAgICAgICBXSVJDb25uZWN0aW9uSWRlbnRpZmllcktleTogY29ubklkLFxuICAgICAgICBXSVJTZW5kZXJLZXk6IHNlbmRlcklkLFxuICAgICAgICBXSVJQYWdlSWRlbnRpZmllcktleTogcGFnZUlkS2V5LFxuICAgICAgICBXSVJBdXRvbWF0aWNhbGx5UGF1c2U6IGZhbHNlXG4gICAgICB9LFxuICAgICAgX19zZWxlY3RvcjogJ19ycGNfZm9yd2FyZFNvY2tldFNldHVwOidcbiAgICB9O1xuICB9XG5cbiAgaW5kaWNhdGVXZWJWaWV3IChjb25uSWQsIGFwcElkS2V5LCBwYWdlSWRLZXksIGVuYWJsZWQpIHtcbiAgICByZXR1cm4ge1xuICAgICAgX19hcmd1bWVudDoge1xuICAgICAgICBXSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk6IGFwcElkS2V5LFxuICAgICAgICBXSVJJbmRpY2F0ZUVuYWJsZWRLZXk6IF8uaXNOaWwoZW5hYmxlZCkgPyB0cnVlIDogZW5hYmxlZCxcbiAgICAgICAgV0lSQ29ubmVjdGlvbklkZW50aWZpZXJLZXk6IGNvbm5JZCxcbiAgICAgICAgV0lSUGFnZUlkZW50aWZpZXJLZXk6IHBhZ2VJZEtleVxuICAgICAgfSxcbiAgICAgIF9fc2VsZWN0b3I6ICdfcnBjX2ZvcndhcmRJbmRpY2F0ZVdlYlZpZXc6J1xuICAgIH07XG4gIH1cblxuICBsYXVuY2hBcHBsaWNhdGlvbiAoYnVuZGxlSWQpIHtcbiAgICByZXR1cm4ge1xuICAgICAgX19hcmd1bWVudDoge1xuICAgICAgICBXSVJBcHBsaWNhdGlvbkJ1bmRsZUlkZW50aWZpZXJLZXk6IGJ1bmRsZUlkXG4gICAgICB9LFxuICAgICAgX19zZWxlY3RvcjogJ19ycGNfcmVxdWVzdEFwcGxpY2F0aW9uTGF1bmNoOidcbiAgICB9O1xuICB9XG5cbiAgZ2V0RnVsbENvbW1hbmQgKG9wdHMgPSB7fSkge1xuICAgIGNvbnN0IHtcbiAgICAgIG1ldGhvZCxcbiAgICAgIHBhcmFtcyxcbiAgICAgIGNvbm5JZCxcbiAgICAgIHNlbmRlcklkLFxuICAgICAgYXBwSWRLZXksXG4gICAgICBwYWdlSWRLZXksXG4gICAgICB0YXJnZXRJZCxcbiAgICAgIGlkLFxuICAgIH0gPSBvcHRzO1xuXG4gICAgLyogVGhlIFdlYiBJbnNwZWN0b3IgaGFzIGEgbnVtYmVyIG9mIHBhcmFtZXRlcnMgdGhhdCBjYW4gYmUgcGFzc2VkIGluLCBhc1xuICAgICAqIHNlZW4gd2hlbiBkdW1waW5nIHdoYXQgU2FmYXJpIGlzIGRvaW5nIHdoZW4gY29tbXVuaWNhdGluZyB3aXRoIGl0LiBNb3N0XG4gICAgICogYXJlIGtlcHQgYXMgdGhleSBhcmUgc2V0IGZvciBTYWZhcmkuIFRoZSBleGNlcHRpb24gaXMgYGVtdWxhdGVVc2VyR2VzdHVyZWBcbiAgICAgKiB3aGljaCwgb24gaU9TIDEzKywgYnJlYWtzIHBvcHVwIGJsb2NraW5nIChpLmUuLCBldmVuIHdpdGggdGhlIHBvcHVwXG4gICAgICogYmxvY2tpbmcgc2V0dGluZyBvbiwgbmV3IHdpbmRvd3MgYXJlIG9wZW5hYmxlIGJvdGggZnJvbSBsaW5rcyBhbmQgZnJvbVxuICAgICAqIEphdmFTY3JpcHQpLlxuICAgICAqL1xuXG4gICAgbGV0IHJlYWxNZXRob2Q7XG4gICAgbGV0IHJlYWxQYXJhbXM7XG4gICAgaWYgKHRoaXMuaXNUYXJnZXRCYXNlZCkge1xuICAgICAgcmVhbE1ldGhvZCA9ICdUYXJnZXQuc2VuZE1lc3NhZ2VUb1RhcmdldCc7XG4gICAgICByZWFsUGFyYW1zID0ge1xuICAgICAgICB0YXJnZXRJZCxcbiAgICAgICAgbWVzc2FnZTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIGlkLFxuICAgICAgICAgIG1ldGhvZCxcbiAgICAgICAgICBwYXJhbXM6IE9iamVjdC5hc3NpZ24oe1xuICAgICAgICAgICAgb2JqZWN0R3JvdXA6IE9CSkVDVF9HUk9VUCxcbiAgICAgICAgICAgIGluY2x1ZGVDb21tYW5kTGluZUFQSTogdHJ1ZSxcbiAgICAgICAgICAgIGRvTm90UGF1c2VPbkV4Y2VwdGlvbnNBbmRNdXRlQ29uc29sZTogZmFsc2UsXG4gICAgICAgICAgICBlbXVsYXRlVXNlckdlc3R1cmU6IGZhbHNlLFxuICAgICAgICAgICAgZ2VuZXJhdGVQcmV2aWV3OiBmYWxzZSxcbiAgICAgICAgICAgIHNhdmVSZXN1bHQ6IGZhbHNlLFxuICAgICAgICAgIH0sIHBhcmFtcylcbiAgICAgICAgfSksXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICByZWFsTWV0aG9kID0gbWV0aG9kO1xuICAgICAgcmVhbFBhcmFtcyA9IE9iamVjdC5hc3NpZ24oe1xuICAgICAgICBvYmplY3RHcm91cDogT0JKRUNUX0dST1VQLFxuICAgICAgICBpbmNsdWRlQ29tbWFuZExpbmVBUEk6IHRydWUsXG4gICAgICAgIGRvTm90UGF1c2VPbkV4Y2VwdGlvbnNBbmRNdXRlQ29uc29sZTogZmFsc2UsXG4gICAgICAgIGVtdWxhdGVVc2VyR2VzdHVyZTogZmFsc2UsXG4gICAgICB9LCBwYXJhbXMpO1xuICAgIH1cblxuICAgIGNvbnN0IHBsaXN0ID0ge1xuICAgICAgX19hcmd1bWVudDoge1xuICAgICAgICBXSVJTb2NrZXREYXRhS2V5OiB7XG4gICAgICAgICAgbWV0aG9kOiByZWFsTWV0aG9kLFxuICAgICAgICAgIHBhcmFtczogcmVhbFBhcmFtcyxcbiAgICAgICAgfSxcbiAgICAgICAgV0lSQ29ubmVjdGlvbklkZW50aWZpZXJLZXk6IGNvbm5JZCxcbiAgICAgICAgV0lSU2VuZGVyS2V5OiBzZW5kZXJJZCxcbiAgICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBhcHBJZEtleSxcbiAgICAgICAgV0lSUGFnZUlkZW50aWZpZXJLZXk6IHBhZ2VJZEtleSxcbiAgICAgIH0sXG4gICAgICBfX3NlbGVjdG9yOiAnX3JwY19mb3J3YXJkU29ja2V0RGF0YTonLFxuICAgIH07XG4gICAgcmV0dXJuIF8ub21pdEJ5KHBsaXN0LCBfLmlzTmlsKTtcbiAgfVxuXG4gIGdldE1pbmltYWxDb21tYW5kIChvcHRzID0ge30pIHtcbiAgICBjb25zdCB7bWV0aG9kLCBwYXJhbXMsIGNvbm5JZCwgc2VuZGVySWQsIGFwcElkS2V5LCBwYWdlSWRLZXksIHRhcmdldElkLCBpZH0gPSBvcHRzO1xuXG4gICAgbGV0IHJlYWxNZXRob2QgPSBtZXRob2Q7XG4gICAgbGV0IHJlYWxQYXJhbXMgPSBwYXJhbXM7XG4gICAgaWYgKHRoaXMuaXNUYXJnZXRCYXNlZCkge1xuICAgICAgcmVhbE1ldGhvZCA9ICdUYXJnZXQuc2VuZE1lc3NhZ2VUb1RhcmdldCc7XG4gICAgICByZWFsUGFyYW1zID0ge1xuICAgICAgICB0YXJnZXRJZCxcbiAgICAgICAgbWVzc2FnZTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIGlkLFxuICAgICAgICAgIG1ldGhvZCxcbiAgICAgICAgICBwYXJhbXMsXG4gICAgICAgIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCBwbGlzdCA9IHtcbiAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgV0lSU29ja2V0RGF0YUtleToge1xuICAgICAgICAgIG1ldGhvZDogcmVhbE1ldGhvZCxcbiAgICAgICAgICBwYXJhbXM6IHJlYWxQYXJhbXMsXG4gICAgICAgIH0sXG4gICAgICAgIFdJUkNvbm5lY3Rpb25JZGVudGlmaWVyS2V5OiBjb25uSWQsXG4gICAgICAgIFdJUlNlbmRlcktleTogc2VuZGVySWQsXG4gICAgICAgIFdJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTogYXBwSWRLZXksXG4gICAgICAgIFdJUlBhZ2VJZGVudGlmaWVyS2V5OiBwYWdlSWRLZXksXG4gICAgICB9LFxuICAgICAgX19zZWxlY3RvcjogJ19ycGNfZm9yd2FyZFNvY2tldERhdGE6J1xuICAgIH07XG4gICAgcmV0dXJuIF8ub21pdEJ5KHBsaXN0LCBfLmlzTmlsKTtcbiAgfVxuXG4gIGdldERpcmVjdENvbW1hbmQgKG9wdHMgPSB7fSkge1xuICAgIGNvbnN0IHttZXRob2QsIHBhcmFtcywgY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgaWR9ID0gb3B0cztcblxuICAgIGNvbnN0IHBsaXN0ID0ge1xuICAgICAgX19hcmd1bWVudDoge1xuICAgICAgICBXSVJTb2NrZXREYXRhS2V5OiB7XG4gICAgICAgICAgaWQsXG4gICAgICAgICAgbWV0aG9kLFxuICAgICAgICAgIHBhcmFtcyxcbiAgICAgICAgfSxcbiAgICAgICAgV0lSQ29ubmVjdGlvbklkZW50aWZpZXJLZXk6IGNvbm5JZCxcbiAgICAgICAgV0lSU2VuZGVyS2V5OiBzZW5kZXJJZCxcbiAgICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBhcHBJZEtleSxcbiAgICAgICAgV0lSUGFnZUlkZW50aWZpZXJLZXk6IHBhZ2VJZEtleSxcbiAgICAgIH0sXG4gICAgICBfX3NlbGVjdG9yOiAnX3JwY19mb3J3YXJkU29ja2V0RGF0YTonXG4gICAgfTtcbiAgICByZXR1cm4gXy5vbWl0QnkocGxpc3QsIF8uaXNOaWwpO1xuICB9XG5cbiAgZ2V0UmVtb3RlQ29tbWFuZCAoY29tbWFuZCwgb3B0cykge1xuICAgIGNvbnN0IHtcbiAgICAgIGlkLFxuICAgICAgY29ubklkLFxuICAgICAgYXBwSWRLZXksXG4gICAgICBzZW5kZXJJZCxcbiAgICAgIHBhZ2VJZEtleSxcbiAgICAgIHRhcmdldElkLFxuICAgIH0gPSBvcHRzO1xuXG4gICAgLy8gZGVhbCB3aXRoIFNhZmFyaSBXZWIgSW5zcGVjdG9yIGNvbW1hbmRzXG4gICAgc3dpdGNoIChjb21tYW5kKSB7XG4gICAgICBjYXNlICdzZXRDb25uZWN0aW9uS2V5JzpcbiAgICAgICAgcmV0dXJuIHRoaXMuc2V0Q29ubmVjdGlvbktleShjb25uSWQpO1xuICAgICAgY2FzZSAnaW5kaWNhdGVXZWJWaWV3JzpcbiAgICAgICAgcmV0dXJuIHRoaXMuaW5kaWNhdGVXZWJWaWV3KGNvbm5JZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgb3B0cy5lbmFibGVkKTtcbiAgICAgIGNhc2UgJ2Nvbm5lY3RUb0FwcCc6XG4gICAgICAgIHJldHVybiB0aGlzLmNvbm5lY3RUb0FwcChjb25uSWQsIGFwcElkS2V5KTtcbiAgICAgIGNhc2UgJ3NldFNlbmRlcktleSc6XG4gICAgICAgIHJldHVybiB0aGlzLnNldFNlbmRlcktleShjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5KTtcbiAgICAgIGNhc2UgJ2xhdW5jaEFwcGxpY2F0aW9uJzpcbiAgICAgICAgcmV0dXJuIHRoaXMubGF1bmNoQXBwbGljYXRpb24ob3B0cy5idW5kbGVJZCk7XG4gICAgfVxuXG4gICAgLy8gZGVhbCB3aXRoIFdlYktpdCBjb21tYW5kc1xuICAgIGNvbnN0IGJ1aWxkZXJGdW5jdGlvbiA9IENPTU1BTkRTW2NvbW1hbmRdIHx8IE1JTklNQUxfQ09NTUFORDtcbiAgICByZXR1cm4gdGhpc1tidWlsZGVyRnVuY3Rpb25dKHtcbiAgICAgIC4uLmdldFByb3RvY29sQ29tbWFuZChpZCwgY29tbWFuZCwgb3B0cyksXG4gICAgICBjb25uSWQsXG4gICAgICBhcHBJZEtleSxcbiAgICAgIHNlbmRlcklkLFxuICAgICAgcGFnZUlkS2V5LFxuICAgICAgdGFyZ2V0SWQsXG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IHsgUmVtb3RlTWVzc2FnZXMgfTtcbmV4cG9ydCBkZWZhdWx0IFJlbW90ZU1lc3NhZ2VzO1xuIl0sImZpbGUiOiJsaWIvcnBjL3JlbW90ZS1tZXNzYWdlcy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
