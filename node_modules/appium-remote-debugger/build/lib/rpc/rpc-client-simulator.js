"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _net = _interopRequireDefault(require("net"));

var _rpcClient = _interopRequireDefault(require("./rpc-client"));

var _appiumIosDevice = require("appium-ios-device");

class RpcClientSimulator extends _rpcClient.default {
  constructor(opts = {}) {
    super(Object.assign({
      shouldCheckForTarget: false
    }, opts));
    const {
      socketPath,
      host = '::1',
      port,
      messageProxy
    } = opts;
    this.host = host;
    this.port = port;
    this.messageProxy = messageProxy;
    this.socket = null;
    this.socketPath = socketPath;
  }

  async connect() {
    if (this.socketPath) {
      if (this.messageProxy) {
        _logger.default.debug(`Connecting to remote debugger via proxy through unix domain socket: '${this.messageProxy}'`);

        this.socket = _net.default.connect(this.messageProxy);
        this.socket.once('connect', () => {
          _logger.default.debug(`Forwarding the actual web inspector socket to the proxy: '${this.socketPath}'`);

          this.socket.write(JSON.stringify({
            socketPath: this.socketPath
          }));
        });
      } else {
        _logger.default.debug(`Connecting to remote debugger through unix domain socket: '${this.socketPath}'`);

        this.socket = _net.default.connect(this.socketPath);
      }
    } else {
      if (this.messageProxy) {
        this.port = this.messageProxy;
      }

      _logger.default.debug(`Connecting to remote debugger ${this.messageProxy ? 'via proxy ' : ''}through TCP: ${this.host}:${this.port}`);

      this.socket = new _net.default.Socket({
        type: 'tcp6'
      });
      this.socket.connect(this.port, this.host);
    }

    this.socket.setNoDelay(true);
    this.socket.setKeepAlive(true);
    this.socket.on('close', () => {
      if (this.isConnected) {
        _logger.default.debug('Debugger socket disconnected');
      }

      this.isConnected = false;
      this.socket = null;
    });
    this.socket.on('end', () => {
      this.isConnected = false;
    });
    this.service = await _appiumIosDevice.services.startWebInspectorService(this.udid, {
      socket: this.socket,
      isSimulator: true,
      osVersion: this.platformVersion,
      verbose: this.logAllCommunication,
      verboseHexDump: this.logAllCommunicationHexDump,
      maxFrameLength: this.webInspectorMaxFrameLength
    });
    this.service.listenMessage(this.receive.bind(this));
    return await new _bluebird.default((resolve, reject) => {
      this.socket.on('connect', () => {
        _logger.default.debug(`Debugger socket connected`);

        this.isConnected = true;
        resolve();
      });
      this.socket.on('error', err => {
        if (this.isConnected) {
          _logger.default.error(`Socket error: ${err.message}`);

          this.isConnected = false;
        }

        reject(err);
      });
    });
  }

  async disconnect() {
    if (!this.isConnected) {
      return;
    }

    _logger.default.debug('Disconnecting from remote debugger');

    await super.disconnect();
    this.service.close();
    this.isConnected = false;
  }

  async sendMessage(cmd) {
    let onSocketError;
    return await new _bluebird.default((resolve, reject) => {
      onSocketError = err => {
        _logger.default.error(`Socket error: ${err.message}`);

        reject(err);
      };

      this.socket.on('error', onSocketError);
      this.service.sendMessage(cmd);
      resolve();
    }).finally(() => {
      try {
        this.socket.removeListener('error', onSocketError);
      } catch (ign) {}
    });
  }

  async receive(data) {
    if (!this.isConnected) {
      return;
    }

    if (!data) {
      return;
    }

    for (const key of ['WIRMessageDataKey', 'WIRDestinationKey', 'WIRSocketDataKey']) {
      if (!_lodash.default.isUndefined(data[key])) {
        data[key] = data[key].toString('utf8');
      }
    }

    await this.messageHandler.handleMessage(data);
  }

}

exports.default = RpcClientSimulator;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9ycGMvcnBjLWNsaWVudC1zaW11bGF0b3IuanMiXSwibmFtZXMiOlsiUnBjQ2xpZW50U2ltdWxhdG9yIiwiUnBjQ2xpZW50IiwiY29uc3RydWN0b3IiLCJvcHRzIiwiT2JqZWN0IiwiYXNzaWduIiwic2hvdWxkQ2hlY2tGb3JUYXJnZXQiLCJzb2NrZXRQYXRoIiwiaG9zdCIsInBvcnQiLCJtZXNzYWdlUHJveHkiLCJzb2NrZXQiLCJjb25uZWN0IiwibG9nIiwiZGVidWciLCJuZXQiLCJvbmNlIiwid3JpdGUiLCJKU09OIiwic3RyaW5naWZ5IiwiU29ja2V0IiwidHlwZSIsInNldE5vRGVsYXkiLCJzZXRLZWVwQWxpdmUiLCJvbiIsImlzQ29ubmVjdGVkIiwic2VydmljZSIsInNlcnZpY2VzIiwic3RhcnRXZWJJbnNwZWN0b3JTZXJ2aWNlIiwidWRpZCIsImlzU2ltdWxhdG9yIiwib3NWZXJzaW9uIiwicGxhdGZvcm1WZXJzaW9uIiwidmVyYm9zZSIsImxvZ0FsbENvbW11bmljYXRpb24iLCJ2ZXJib3NlSGV4RHVtcCIsImxvZ0FsbENvbW11bmljYXRpb25IZXhEdW1wIiwibWF4RnJhbWVMZW5ndGgiLCJ3ZWJJbnNwZWN0b3JNYXhGcmFtZUxlbmd0aCIsImxpc3Rlbk1lc3NhZ2UiLCJyZWNlaXZlIiwiYmluZCIsIkIiLCJyZXNvbHZlIiwicmVqZWN0IiwiZXJyIiwiZXJyb3IiLCJtZXNzYWdlIiwiZGlzY29ubmVjdCIsImNsb3NlIiwic2VuZE1lc3NhZ2UiLCJjbWQiLCJvblNvY2tldEVycm9yIiwiZmluYWxseSIsInJlbW92ZUxpc3RlbmVyIiwiaWduIiwiZGF0YSIsImtleSIsIl8iLCJpc1VuZGVmaW5lZCIsInRvU3RyaW5nIiwibWVzc2FnZUhhbmRsZXIiLCJoYW5kbGVNZXNzYWdlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdlLE1BQU1BLGtCQUFOLFNBQWlDQyxrQkFBakMs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dkJoQyx3QkFBSWlDLEtBQUosQ0FBVyxpQkFBZ0JELEdBQUcsQ0FBQ0UsT0FBUSxFQUF2Qzs7QUFHQUgsUUFBQUEsTUFBTSxDQUFDQyxHQUFELENBQU47QUFDRCxPQUxEOztBQU9BLFdBQUtsQyxNQUFMLENBQVlhLEVBQVosQ0FBZSxPQUFmLEVBQXdCNEIsYUFBeEI7QUFDQSxXQUFLMUIsT0FBTCxDQUFhd0IsV0FBYixDQUF5QkMsR0FBekI7QUFDQVIsTUFBQUEsT0FBTztBQUNSLEtBWlksRUFhWlUsT0FiWSxDQWFKLE1BQU07QUFFYixVQUFJO0FBQ0YsYUFBSzFDLE1BQUwsQ0FBWTJDLGNBQVosQ0FBMkIsT0FBM0IsRUFBb0NGLGFBQXBDO0FBQ0QsT0FGRCxDQUVFLE9BQU9HLEdBQVAsRUFBWSxDQUFFO0FBQ2pCLEtBbEJZLENBQWI7QUFtQkQ7O0FBRVksUUFBUGYsT0FBTyxDQUFFZ0IsSUFBRixFQUFRO0FBQ25CLFFBQUksQ0FBQyxLQUFLL0IsV0FBVixFQUF1QjtBQUNyQjtBQUNEOztBQUVELFFBQUksQ0FBQytCLElBQUwsRUFBVztBQUNUO0FBQ0Q7O0FBRUQsU0FBSyxNQUFNQyxHQUFYLElBQWtCLENBQUMsbUJBQUQsRUFBc0IsbUJBQXRCLEVBQTJDLGtCQUEzQyxDQUFsQixFQUFrRjtBQUNoRixVQUFJLENBQUNDLGdCQUFFQyxXQUFGLENBQWNILElBQUksQ0FBQ0MsR0FBRCxDQUFsQixDQUFMLEVBQStCO0FBQzdCRCxRQUFBQSxJQUFJLENBQUNDLEdBQUQsQ0FBSixHQUFZRCxJQUFJLENBQUNDLEdBQUQsQ0FBSixDQUFVRyxRQUFWLENBQW1CLE1BQW5CLENBQVo7QUFDRDtBQUNGOztBQUNELFVBQU0sS0FBS0MsY0FBTCxDQUFvQkMsYUFBcEIsQ0FBa0NOLElBQWxDLENBQU47QUFDRDs7QUFwSnVEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBuZXQgZnJvbSAnbmV0JztcbmltcG9ydCBScGNDbGllbnQgZnJvbSAnLi9ycGMtY2xpZW50JztcbmltcG9ydCB7IHNlcnZpY2VzIH0gZnJvbSAnYXBwaXVtLWlvcy1kZXZpY2UnO1xuXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJwY0NsaWVudFNpbXVsYXRvciBleHRlbmRzIFJwY0NsaWVudCB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBzdXBlcihPYmplY3QuYXNzaWduKHtcbiAgICAgIHNob3VsZENoZWNrRm9yVGFyZ2V0OiBmYWxzZSxcbiAgICB9LCBvcHRzKSk7XG5cbiAgICBjb25zdCB7XG4gICAgICBzb2NrZXRQYXRoLFxuICAgICAgaG9zdCA9ICc6OjEnLFxuICAgICAgcG9ydCxcbiAgICAgIG1lc3NhZ2VQcm94eSxcbiAgICB9ID0gb3B0cztcblxuICAgIC8vIGhvc3QvcG9ydCBjb25maWcgZm9yIFRDUCBjb21tdW5pY2F0aW9uLCBzb2NrZXRQYXRoIGZvciB1bml4IGRvbWFpbiBzb2NrZXRzXG4gICAgdGhpcy5ob3N0ID0gaG9zdDtcbiAgICB0aGlzLnBvcnQgPSBwb3J0O1xuICAgIHRoaXMubWVzc2FnZVByb3h5ID0gbWVzc2FnZVByb3h5O1xuXG4gICAgdGhpcy5zb2NrZXQgPSBudWxsO1xuICAgIHRoaXMuc29ja2V0UGF0aCA9IHNvY2tldFBhdGg7XG4gIH1cblxuICBhc3luYyBjb25uZWN0ICgpIHtcbiAgICAvLyBjcmVhdGUgc29ja2V0IGFuZCBoYW5kbGUgaXRzIG1lc3NhZ2VzXG4gICAgaWYgKHRoaXMuc29ja2V0UGF0aCkge1xuICAgICAgaWYgKHRoaXMubWVzc2FnZVByb3h5KSB7XG4gICAgICAgIC8vIHVuaXggZG9tYWluIHNvY2tldCB2aWEgcHJveHlcbiAgICAgICAgbG9nLmRlYnVnKGBDb25uZWN0aW5nIHRvIHJlbW90ZSBkZWJ1Z2dlciB2aWEgcHJveHkgdGhyb3VnaCB1bml4IGRvbWFpbiBzb2NrZXQ6ICcke3RoaXMubWVzc2FnZVByb3h5fSdgKTtcbiAgICAgICAgdGhpcy5zb2NrZXQgPSBuZXQuY29ubmVjdCh0aGlzLm1lc3NhZ2VQcm94eSk7XG5cbiAgICAgICAgLy8gRm9yd2FyZCB0aGUgYWN0dWFsIHNvY2tldFBhdGggdG8gdGhlIHByb3h5XG4gICAgICAgIHRoaXMuc29ja2V0Lm9uY2UoJ2Nvbm5lY3QnLCAoKSA9PiB7XG4gICAgICAgICAgbG9nLmRlYnVnKGBGb3J3YXJkaW5nIHRoZSBhY3R1YWwgd2ViIGluc3BlY3RvciBzb2NrZXQgdG8gdGhlIHByb3h5OiAnJHt0aGlzLnNvY2tldFBhdGh9J2ApO1xuICAgICAgICAgIHRoaXMuc29ja2V0LndyaXRlKEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIHNvY2tldFBhdGg6IHRoaXMuc29ja2V0UGF0aFxuICAgICAgICAgIH0pKTtcbiAgICAgICAgfSk7XG5cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHVuaXggZG9tYWluIHNvY2tldFxuICAgICAgICBsb2cuZGVidWcoYENvbm5lY3RpbmcgdG8gcmVtb3RlIGRlYnVnZ2VyIHRocm91Z2ggdW5peCBkb21haW4gc29ja2V0OiAnJHt0aGlzLnNvY2tldFBhdGh9J2ApO1xuICAgICAgICB0aGlzLnNvY2tldCA9IG5ldC5jb25uZWN0KHRoaXMuc29ja2V0UGF0aCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLm1lc3NhZ2VQcm94eSkge1xuICAgICAgICAvLyBjb25uZWN0IHRvIHRoZSBwcm94eSBpbnN0ZWFkIG9mIHRoZSByZW1vdGUgZGVidWdnZXIgZGlyZWN0bHlcbiAgICAgICAgdGhpcy5wb3J0ID0gdGhpcy5tZXNzYWdlUHJveHk7XG4gICAgICB9XG5cbiAgICAgIC8vIHRjcCBzb2NrZXRcbiAgICAgIGxvZy5kZWJ1ZyhgQ29ubmVjdGluZyB0byByZW1vdGUgZGVidWdnZXIgJHt0aGlzLm1lc3NhZ2VQcm94eSA/ICd2aWEgcHJveHkgJyA6ICcnfXRocm91Z2ggVENQOiAke3RoaXMuaG9zdH06JHt0aGlzLnBvcnR9YCk7XG4gICAgICB0aGlzLnNvY2tldCA9IG5ldyBuZXQuU29ja2V0KHt0eXBlOiAndGNwNid9KTtcbiAgICAgIHRoaXMuc29ja2V0LmNvbm5lY3QodGhpcy5wb3J0LCB0aGlzLmhvc3QpO1xuICAgIH1cblxuICAgIHRoaXMuc29ja2V0LnNldE5vRGVsYXkodHJ1ZSk7XG4gICAgdGhpcy5zb2NrZXQuc2V0S2VlcEFsaXZlKHRydWUpO1xuICAgIHRoaXMuc29ja2V0Lm9uKCdjbG9zZScsICgpID0+IHtcbiAgICAgIGlmICh0aGlzLmlzQ29ubmVjdGVkKSB7XG4gICAgICAgIGxvZy5kZWJ1ZygnRGVidWdnZXIgc29ja2V0IGRpc2Nvbm5lY3RlZCcpO1xuICAgICAgfVxuICAgICAgdGhpcy5pc0Nvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgdGhpcy5zb2NrZXQgPSBudWxsO1xuICAgIH0pO1xuICAgIHRoaXMuc29ja2V0Lm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICB0aGlzLmlzQ29ubmVjdGVkID0gZmFsc2U7XG4gICAgfSk7XG4gICAgdGhpcy5zZXJ2aWNlID0gYXdhaXQgc2VydmljZXMuc3RhcnRXZWJJbnNwZWN0b3JTZXJ2aWNlKHRoaXMudWRpZCwge1xuICAgICAgc29ja2V0OiB0aGlzLnNvY2tldCxcbiAgICAgIGlzU2ltdWxhdG9yOiB0cnVlLFxuICAgICAgb3NWZXJzaW9uOiB0aGlzLnBsYXRmb3JtVmVyc2lvbixcbiAgICAgIHZlcmJvc2U6IHRoaXMubG9nQWxsQ29tbXVuaWNhdGlvbixcbiAgICAgIHZlcmJvc2VIZXhEdW1wOiB0aGlzLmxvZ0FsbENvbW11bmljYXRpb25IZXhEdW1wLFxuICAgICAgbWF4RnJhbWVMZW5ndGg6IHRoaXMud2ViSW5zcGVjdG9yTWF4RnJhbWVMZW5ndGgsXG4gICAgfSk7XG4gICAgdGhpcy5zZXJ2aWNlLmxpc3Rlbk1lc3NhZ2UodGhpcy5yZWNlaXZlLmJpbmQodGhpcykpO1xuXG4gICAgLy8gY29ubmVjdCB0aGUgc29ja2V0XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIC8vIG9ubHkgcmVzb2x2ZSB0aGlzIGZ1bmN0aW9uIHdoZW4gd2UgYXJlIGFjdHVhbGx5IGNvbm5lY3RlZFxuICAgICAgdGhpcy5zb2NrZXQub24oJ2Nvbm5lY3QnLCAoKSA9PiB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgRGVidWdnZXIgc29ja2V0IGNvbm5lY3RlZGApO1xuICAgICAgICB0aGlzLmlzQ29ubmVjdGVkID0gdHJ1ZTtcblxuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgICAgaWYgKHRoaXMuaXNDb25uZWN0ZWQpIHtcbiAgICAgICAgICBsb2cuZXJyb3IoYFNvY2tldCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgICAgICB0aGlzLmlzQ29ubmVjdGVkID0gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICAvLyB0aGUgY29ubmVjdGlvbiB3YXMgcmVmdXNlZCwgc28gcmVqZWN0IHRoZSBjb25uZWN0IHByb21pc2VcbiAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGRpc2Nvbm5lY3QgKCkge1xuICAgIGlmICghdGhpcy5pc0Nvbm5lY3RlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxvZy5kZWJ1ZygnRGlzY29ubmVjdGluZyBmcm9tIHJlbW90ZSBkZWJ1Z2dlcicpO1xuICAgIGF3YWl0IHN1cGVyLmRpc2Nvbm5lY3QoKTtcbiAgICB0aGlzLnNlcnZpY2UuY2xvc2UoKTtcbiAgICB0aGlzLmlzQ29ubmVjdGVkID0gZmFsc2U7XG4gIH1cblxuICBhc3luYyBzZW5kTWVzc2FnZSAoY21kKSB7XG4gICAgbGV0IG9uU29ja2V0RXJyb3I7XG5cbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8gaGFuZGxlIHNvY2tldCBwcm9ibGVtc1xuICAgICAgb25Tb2NrZXRFcnJvciA9IChlcnIpID0+IHtcbiAgICAgICAgbG9nLmVycm9yKGBTb2NrZXQgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG5cbiAgICAgICAgLy8gdGhlIGNvbm5lY3Rpb24gd2FzIHJlZnVzZWQsIHNvIHJlamVjdCB0aGUgY29ubmVjdCBwcm9taXNlXG4gICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgfTtcblxuICAgICAgdGhpcy5zb2NrZXQub24oJ2Vycm9yJywgb25Tb2NrZXRFcnJvcik7XG4gICAgICB0aGlzLnNlcnZpY2Uuc2VuZE1lc3NhZ2UoY21kKTtcbiAgICAgIHJlc29sdmUoKTtcbiAgICB9KVxuICAgIC5maW5hbGx5KCgpID0+IHtcbiAgICAgIC8vIHJlbW92ZSB0aGlzIGxpc3RlbmVyLCBzbyB3ZSBkb24ndCBleGhhdXN0IHRoZSBzeXN0ZW1cbiAgICAgIHRyeSB7XG4gICAgICAgIHRoaXMuc29ja2V0LnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIG9uU29ja2V0RXJyb3IpO1xuICAgICAgfSBjYXRjaCAoaWduKSB7fVxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgcmVjZWl2ZSAoZGF0YSkge1xuICAgIGlmICghdGhpcy5pc0Nvbm5lY3RlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghZGF0YSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGZvciAoY29uc3Qga2V5IG9mIFsnV0lSTWVzc2FnZURhdGFLZXknLCAnV0lSRGVzdGluYXRpb25LZXknLCAnV0lSU29ja2V0RGF0YUtleSddKSB7XG4gICAgICBpZiAoIV8uaXNVbmRlZmluZWQoZGF0YVtrZXldKSkge1xuICAgICAgICBkYXRhW2tleV0gPSBkYXRhW2tleV0udG9TdHJpbmcoJ3V0ZjgnKTtcbiAgICAgIH1cbiAgICB9XG4gICAgYXdhaXQgdGhpcy5tZXNzYWdlSGFuZGxlci5oYW5kbGVNZXNzYWdlKGRhdGEpO1xuICB9XG59XG4iXSwiZmlsZSI6ImxpYi9ycGMvcnBjLWNsaWVudC1zaW11bGF0b3IuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
