"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _utils = require("../utils");

var _events = _interopRequireDefault(require("./events"));

var _support = require("@appium/support");

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

function frameDetached() {
  this.emit(_events.default.EVENT_FRAMES_DETACHED);
}

async function pageLoad(startPageLoadTimer, pageLoadVerifyHook = _lodash.default.noop) {
  var _startPageLoadTimer;

  const timeoutMs = 500;

  if (!_lodash.default.isFunction((_startPageLoadTimer = startPageLoadTimer) === null || _startPageLoadTimer === void 0 ? void 0 : _startPageLoadTimer.getDuration)) {
    _logger.default.debug(`Page load timer not a timer. Creating new timer`);

    startPageLoadTimer = new _support.timing.Timer().start();
  }

  _logger.default.debug('Page loaded, verifying whether ready');

  this.pageLoading = true;

  const verify = async () => {
    this.pageLoadDelay = _support.util.cancellableDelay(timeoutMs);

    try {
      await this.pageLoadDelay;
    } catch (err) {
      if (err instanceof _bluebird.default.CancellationError) {
        return;
      }
    }

    if (!this.appIdKey) {
      _logger.default.debug('Not connected to an application. Ignoring page load');

      return;
    }

    if (_lodash.default.isFunction(pageLoadVerifyHook)) {
      await pageLoadVerifyHook();
    }

    const elapsedMs = startPageLoadTimer.getDuration().asMilliSeconds;

    if ((await this.checkPageIsReady()) || this.pageLoadMs > 0 && elapsedMs > this.pageLoadMs) {
      _logger.default.debug('Page is ready');

      this.pageLoading = false;
    } else {
      _logger.default.debug('Page was not ready, retrying');

      await verify();
    }
  };

  try {
    await verify();
  } finally {
    _logger.default.debug(`Page load completed in ${startPageLoadTimer.getDuration().asMilliSeconds.toFixed(0)}ms`);

    this.pageLoading = false;
  }
}

function cancelPageLoad() {
  _logger.default.debug('Unregistering from page readiness notifications');

  this.pageLoading = false;

  if (this.pageLoadDelay) {
    this.pageLoadDelay.cancel();
  }
}

async function pageUnload() {
  _logger.default.debug('Page unloading');

  await this.waitForDom();
}

async function waitForDom(startPageLoadTimer, pageLoadVerifyHook) {
  _logger.default.debug('Waiting for dom...');

  await this.pageLoad(startPageLoadTimer, pageLoadVerifyHook);
}

async function checkPageIsReady() {
  (0, _utils.checkParams)({
    appIdKey: this.appIdKey
  });

  _logger.default.debug('Checking document readyState');

  const readyCmd = 'document.readyState;';
  let readyState = 'loading';

  try {
    readyState = await _bluebird.default.resolve(this.execute(readyCmd, true)).timeout(this.pageReadyTimeout);
  } catch (err) {
    if (!(err instanceof _bluebird.default.TimeoutError)) {
      throw err;
    }

    _logger.default.debug(`Page readiness check timed out after ${this.pageReadyTimeout}ms`);

    return false;
  }

  _logger.default.debug(`Document readyState is '${readyState}'`);

  return readyState === 'complete';
}

async function navToUrl(url, pageLoadVerifyHook) {
  (0, _utils.checkParams)({
    appIdKey: this.appIdKey,
    pageIdKey: this.pageIdKey
  });
  this._navigatingToPage = true;

  try {
    _logger.default.debug(`Navigating to new URL: '${url}'`);

    const waitForFramePromise = this.waitForFrameNavigated();
    await this.rpcClient.send('Page.navigate', {
      url,
      appIdKey: this.appIdKey,
      pageIdKey: this.pageIdKey
    });

    if (!this.useNewSafari) {
      await _bluebird.default.delay(1000);
    }

    await waitForFramePromise;
    await this.waitForDom(new _support.timing.Timer().start(), pageLoadVerifyHook);
    await this.rpcClient.send('Console.enable', {
      appIdKey: this.appIdKey,
      pageIdKey: this.pageIdKey
    });
  } finally {
    this._navigatingToPage = false;
  }
}

async function waitForFrameNavigated() {
  let navEventListener;
  return await new _bluebird.default(async resolve => {
    _logger.default.debug('Waiting for frame navigated message...');

    const start = new _support.timing.Timer().start();

    navEventListener = (err, value) => {
      _logger.default.debug(`Frame navigated in ${start.getDuration().asMilliSeconds.toFixed(0)}ms from: ${value}`);

      if (!this.allowNavigationWithoutReload && !this.pageLoading) {
        resolve(value);
      } else {
        _logger.default.debug('Frame navigated but we were warned about it, not ' + 'considering page state unloaded');

        this.allowNavigationWithoutReload = false;
      }

      if (this.navigationDelay) {
        this.navigationDelay.cancel();
      }
    };

    this.rpcClient.once('Page.frameNavigated', navEventListener);

    if (!this.useNewSafari || this.pageLoadMs >= 0) {
      const timeout = this.useNewSafari ? this.pageLoadMs : 500;
      this.navigationDelay = _support.util.cancellableDelay(timeout);

      try {
        await this.navigationDelay;
        navEventListener(null, `${timeout}ms timeout`);
      } catch (err) {}
    }
  }).finally(() => {
    if (navEventListener) {
      this.rpcClient.off('Page.frameNavigated', navEventListener);
    }
  });
}

var _default = {
  frameDetached,
  pageLoad,
  cancelPageLoad,
  pageUnload,
  waitForDom,
  checkPageIsReady,
  navToUrl,
  waitForFrameNavigated
};
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9taXhpbnMvbmF2aWdhdGUuanMiXSwibmFtZXMiOlsiZnJhbWVEZXRhY2hlZCIsImVtaXQiLCJldmVudHMiLCJFVkVOVF9GUkFNRVNfREVUQUNIRUQiLCJwYWdlTG9hZCIsInN0YXJ0UGFnZUxvYWRUaW1lciIsInBhZ2VMb2FkVmVyaWZ5SG9vayIsIl8iLCJub29wIiwidGltZW91dE1zIiwiaXNGdW5jdGlvbiIsImdldER1cmF0aW9uIiwibG9nIiwiZGVidWciLCJ0aW1pbmciLCJUaW1lciIsInN0YXJ0IiwicGFnZUxvYWRpbmciLCJ2ZXJpZnkiLCJwYWdlTG9hZERlbGF5IiwidXRpbCIsImNhbmNlbGxhYmxlRGVsYXkiLCJlcnIiLCJCIiwiQ2FuY2VsbGF0aW9uRXJyb3IiLCJhcHBJZEtleSIsImVsYXBzZWRNcyIsImFzTWlsbGlTZWNvbmRzIiwiY2hlY2tQYWdlSXNSZWFkeSIsInBhZ2VMb2FkTXMiLCJ0b0ZpeGVkIiwiY2FuY2VsUGFnZUxvYWQiLCJjYW5jZWwiLCJwYWdlVW5sb2FkIiwid2FpdEZvckRvbSIsInJlYWR5Q21kIiwicmVhZHlTdGF0ZSIsInJlc29sdmUiLCJleGVjdXRlIiwidGltZW91dCIsInBhZ2VSZWFkeVRpbWVvdXQiLCJUaW1lb3V0RXJyb3IiLCJuYXZUb1VybCIsInVybCIsInBhZ2VJZEtleSIsIl9uYXZpZ2F0aW5nVG9QYWdlIiwid2FpdEZvckZyYW1lUHJvbWlzZSIsIndhaXRGb3JGcmFtZU5hdmlnYXRlZCIsInJwY0NsaWVudCIsInNlbmQiLCJ1c2VOZXdTYWZhcmkiLCJkZWxheSIsIm5hdkV2ZW50TGlzdGVuZXIiLCJ2YWx1ZSIsImFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQiLCJuYXZpZ2F0aW9uRGVsYXkiLCJvbmNlIiwiZmluYWxseSIsIm9mZiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxTQUFTQSxhQUFULEdBQTBCO0FBQ3hCLE9B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LEtBQUtGLFlBQU4sSUFBc0IsS0FBS3JCLFVBQUwsSUFBbUIsQ0FBN0MsRUFBZ0Q7QUFFOUMsWUFBTVUsT0FBTyxHQUFHLEtBQUtXLFlBQUwsR0FBb0IsS0FBS3JCLFVBQXpCLEdBQXNDLEdBQXREO0FBQ0EsV0FBSzBCLGVBQUwsR0FBdUJuQyxjQUFLQyxnQkFBTCxDQUFzQmtCLE9BQXRCLENBQXZCOztBQUNBLFVBQUk7QUFDRixjQUFNLEtBQUtnQixlQUFYO0FBQ0FILFFBQUFBLGdCQUFnQixDQUFDLElBQUQsRUFBUSxHQUFFYixPQUFRLFlBQWxCLENBQWhCO0FBQ0QsT0FIRCxDQUdFLE9BQU9qQixHQUFQLEVBQVksQ0FJYjtBQUNGO0FBQ0YsR0FyQ1ksRUFxQ1ZtQyxPQXJDVSxDQXFDRixNQUFNO0FBQ2YsUUFBSUwsZ0JBQUosRUFBc0I7QUFDcEIsV0FBS0osU0FBTCxDQUFlVSxHQUFmLENBQW1CLHFCQUFuQixFQUEwQ04sZ0JBQTFDO0FBQ0Q7QUFDRixHQXpDWSxDQUFiO0FBMENEOztlQUdjO0FBQUVwRCxFQUFBQSxhQUFGO0FBQWlCSSxFQUFBQSxRQUFqQjtBQUEyQjJCLEVBQUFBLGNBQTNCO0FBQTJDRSxFQUFBQSxVQUEzQztBQUF1REMsRUFBQUEsVUFBdkQ7QUFBbUVOLEVBQUFBLGdCQUFuRTtBQUFxRmMsRUFBQUEsUUFBckY7QUFBK0ZLLEVBQUFBO0FBQS9GLEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBjaGVja1BhcmFtcyB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCBldmVudHMgZnJvbSAnLi9ldmVudHMnO1xuaW1wb3J0IHsgdGltaW5nLCB1dGlsIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5cblxuZnVuY3Rpb24gZnJhbWVEZXRhY2hlZCAoKSB7XG4gIHRoaXMuZW1pdChldmVudHMuRVZFTlRfRlJBTUVTX0RFVEFDSEVEKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcGFnZUxvYWQgKHN0YXJ0UGFnZUxvYWRUaW1lciwgcGFnZUxvYWRWZXJpZnlIb29rID0gXy5ub29wKSB7XG4gIGNvbnN0IHRpbWVvdXRNcyA9IDUwMDtcbiAgaWYgKCFfLmlzRnVuY3Rpb24oc3RhcnRQYWdlTG9hZFRpbWVyPy5nZXREdXJhdGlvbikpIHtcbiAgICBsb2cuZGVidWcoYFBhZ2UgbG9hZCB0aW1lciBub3QgYSB0aW1lci4gQ3JlYXRpbmcgbmV3IHRpbWVyYCk7XG4gICAgc3RhcnRQYWdlTG9hZFRpbWVyID0gbmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCk7XG4gIH1cblxuICBsb2cuZGVidWcoJ1BhZ2UgbG9hZGVkLCB2ZXJpZnlpbmcgd2hldGhlciByZWFkeScpO1xuICB0aGlzLnBhZ2VMb2FkaW5nID0gdHJ1ZTtcblxuICBjb25zdCB2ZXJpZnkgPSBhc3luYyAoKSA9PiB7XG4gICAgdGhpcy5wYWdlTG9hZERlbGF5ID0gdXRpbC5jYW5jZWxsYWJsZURlbGF5KHRpbWVvdXRNcyk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMucGFnZUxvYWREZWxheTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBCLkNhbmNlbGxhdGlvbkVycm9yKSB7XG4gICAgICAgIC8vIGlmIHRoZSBwcm9taXNlIGhhcyBiZWVuIGNhbmNlbGxlZFxuICAgICAgICAvLyB3ZSB3YW50IHRvIHNraXAgY2hlY2tpbmcgdGhlIHJlYWRpbmVzc1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gd2UgY2FuIGdldCB0aGlzIGNhbGxlZCBpbiB0aGUgbWlkZGxlIG9mIHRyeWluZyB0byBmaW5kIGEgbmV3IGFwcFxuICAgIGlmICghdGhpcy5hcHBJZEtleSkge1xuICAgICAgbG9nLmRlYnVnKCdOb3QgY29ubmVjdGVkIHRvIGFuIGFwcGxpY2F0aW9uLiBJZ25vcmluZyBwYWdlIGxvYWQnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoXy5pc0Z1bmN0aW9uKHBhZ2VMb2FkVmVyaWZ5SG9vaykpIHtcbiAgICAgIGF3YWl0IHBhZ2VMb2FkVmVyaWZ5SG9vaygpO1xuICAgIH1cblxuICAgIC8vIGlmIHdlIGFyZSByZWFkeSwgb3Igd2UndmUgc3BlbmQgdG9vIG11Y2ggdGltZSBvbiB0aGlzXG4gICAgY29uc3QgZWxhcHNlZE1zID0gc3RhcnRQYWdlTG9hZFRpbWVyLmdldER1cmF0aW9uKCkuYXNNaWxsaVNlY29uZHM7XG4gICAgaWYgKGF3YWl0IHRoaXMuY2hlY2tQYWdlSXNSZWFkeSgpIHx8ICh0aGlzLnBhZ2VMb2FkTXMgPiAwICYmIGVsYXBzZWRNcyA+IHRoaXMucGFnZUxvYWRNcykpIHtcbiAgICAgIGxvZy5kZWJ1ZygnUGFnZSBpcyByZWFkeScpO1xuICAgICAgdGhpcy5wYWdlTG9hZGluZyA9IGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuZGVidWcoJ1BhZ2Ugd2FzIG5vdCByZWFkeSwgcmV0cnlpbmcnKTtcbiAgICAgIGF3YWl0IHZlcmlmeSgpO1xuICAgIH1cbiAgfTtcbiAgdHJ5IHtcbiAgICBhd2FpdCB2ZXJpZnkoKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBsb2cuZGVidWcoYFBhZ2UgbG9hZCBjb21wbGV0ZWQgaW4gJHtzdGFydFBhZ2VMb2FkVGltZXIuZ2V0RHVyYXRpb24oKS5hc01pbGxpU2Vjb25kcy50b0ZpeGVkKDApfW1zYCk7XG4gICAgdGhpcy5wYWdlTG9hZGluZyA9IGZhbHNlO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNhbmNlbFBhZ2VMb2FkICgpIHtcbiAgbG9nLmRlYnVnKCdVbnJlZ2lzdGVyaW5nIGZyb20gcGFnZSByZWFkaW5lc3Mgbm90aWZpY2F0aW9ucycpO1xuICB0aGlzLnBhZ2VMb2FkaW5nID0gZmFsc2U7XG4gIGlmICh0aGlzLnBhZ2VMb2FkRGVsYXkpIHtcbiAgICB0aGlzLnBhZ2VMb2FkRGVsYXkuY2FuY2VsKCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcGFnZVVubG9hZCAoKSB7XG4gIGxvZy5kZWJ1ZygnUGFnZSB1bmxvYWRpbmcnKTtcbiAgYXdhaXQgdGhpcy53YWl0Rm9yRG9tKCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHdhaXRGb3JEb20gKHN0YXJ0UGFnZUxvYWRUaW1lciwgcGFnZUxvYWRWZXJpZnlIb29rKSB7XG4gIGxvZy5kZWJ1ZygnV2FpdGluZyBmb3IgZG9tLi4uJyk7XG4gIGF3YWl0IHRoaXMucGFnZUxvYWQoc3RhcnRQYWdlTG9hZFRpbWVyLCBwYWdlTG9hZFZlcmlmeUhvb2spO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjaGVja1BhZ2VJc1JlYWR5ICgpIHtcbiAgY2hlY2tQYXJhbXMoe2FwcElkS2V5OiB0aGlzLmFwcElkS2V5fSk7XG5cbiAgbG9nLmRlYnVnKCdDaGVja2luZyBkb2N1bWVudCByZWFkeVN0YXRlJyk7XG4gIGNvbnN0IHJlYWR5Q21kID0gJ2RvY3VtZW50LnJlYWR5U3RhdGU7JztcbiAgbGV0IHJlYWR5U3RhdGUgPSAnbG9hZGluZyc7XG4gIHRyeSB7XG4gICAgcmVhZHlTdGF0ZSA9IGF3YWl0IEIucmVzb2x2ZSh0aGlzLmV4ZWN1dGUocmVhZHlDbWQsIHRydWUpKS50aW1lb3V0KHRoaXMucGFnZVJlYWR5VGltZW91dCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmICghKGVyciBpbnN0YW5jZW9mIEIuVGltZW91dEVycm9yKSkge1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYFBhZ2UgcmVhZGluZXNzIGNoZWNrIHRpbWVkIG91dCBhZnRlciAke3RoaXMucGFnZVJlYWR5VGltZW91dH1tc2ApO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICBsb2cuZGVidWcoYERvY3VtZW50IHJlYWR5U3RhdGUgaXMgJyR7cmVhZHlTdGF0ZX0nYCk7XG5cbiAgcmV0dXJuIHJlYWR5U3RhdGUgPT09ICdjb21wbGV0ZSc7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIG5hdlRvVXJsICh1cmwsIHBhZ2VMb2FkVmVyaWZ5SG9vaykge1xuICBjaGVja1BhcmFtcyh7YXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXl9KTtcblxuICB0aGlzLl9uYXZpZ2F0aW5nVG9QYWdlID0gdHJ1ZTtcblxuICB0cnkge1xuICAgIGxvZy5kZWJ1ZyhgTmF2aWdhdGluZyB0byBuZXcgVVJMOiAnJHt1cmx9J2ApO1xuXG4gICAgLy8gYmVnaW4gbGlzdGVuaW5nIGZvciBmcmFtZSBuYXZpZ2F0aW9uIGV2ZW50LCB3aGljaCB3aWxsIGJlIHdhaXRlZCBmb3IgbGF0ZXJcbiAgICBjb25zdCB3YWl0Rm9yRnJhbWVQcm9taXNlID0gdGhpcy53YWl0Rm9yRnJhbWVOYXZpZ2F0ZWQoKTtcblxuICAgIGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQoJ1BhZ2UubmF2aWdhdGUnLCB7XG4gICAgICB1cmwsXG4gICAgICBhcHBJZEtleTogdGhpcy5hcHBJZEtleSxcbiAgICAgIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXksXG4gICAgfSk7XG5cbiAgICBpZiAoIXRoaXMudXNlTmV3U2FmYXJpKSB7XG4gICAgICAvLyBhIHNtYWxsIHBhdXNlIGZvciB0aGUgYnJvd3NlciB0byBjYXRjaCB1cFxuICAgICAgYXdhaXQgQi5kZWxheSgxMDAwKTtcbiAgICB9XG5cbiAgICAvLyB3YWl0IHVudGlsIHRoZSBwYWdlIGhhcyBiZWVuIG5hdmlnYXRlZFxuICAgIGF3YWl0IHdhaXRGb3JGcmFtZVByb21pc2U7XG5cbiAgICBhd2FpdCB0aGlzLndhaXRGb3JEb20obmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCksIHBhZ2VMb2FkVmVyaWZ5SG9vayk7XG5cbiAgICAvLyBlbmFibGUgY29uc29sZSBsb2dnaW5nLCBzbyB3ZSBnZXQgdGhlIGV2ZW50cyAob3RoZXJ3aXNlIHdlIG9ubHlcbiAgICAvLyBnZXQgbm90aWZpZWQgd2hlbiBuYXZpZ2F0aW5nIHRvIGEgbG9jYWwgcGFnZVxuICAgIGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQoJ0NvbnNvbGUuZW5hYmxlJywge1xuICAgICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICAgIH0pO1xuICB9IGZpbmFsbHkge1xuICAgIHRoaXMuX25hdmlnYXRpbmdUb1BhZ2UgPSBmYWxzZTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiB3YWl0Rm9yRnJhbWVOYXZpZ2F0ZWQgKCkge1xuICBsZXQgbmF2RXZlbnRMaXN0ZW5lcjtcbiAgcmV0dXJuIGF3YWl0IG5ldyBCKGFzeW5jIChyZXNvbHZlKSA9PiB7XG4gICAgbG9nLmRlYnVnKCdXYWl0aW5nIGZvciBmcmFtZSBuYXZpZ2F0ZWQgbWVzc2FnZS4uLicpO1xuICAgIGNvbnN0IHN0YXJ0ID0gbmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCk7XG5cbiAgICAvLyBhZGQgYSBoYW5kbGVyIGZvciB0aGUgYFBhZ2UuZnJhbWVOYXZpZ2F0ZWRgIG1lc3NhZ2VcbiAgICAvLyBmcm9tIHRoZSByZW1vdGUgZGVidWdnZXJcbiAgICBuYXZFdmVudExpc3RlbmVyID0gKGVyciwgdmFsdWUpID0+IHtcbiAgICAgIGxvZy5kZWJ1ZyhgRnJhbWUgbmF2aWdhdGVkIGluICR7c3RhcnQuZ2V0RHVyYXRpb24oKS5hc01pbGxpU2Vjb25kcy50b0ZpeGVkKDApfW1zIGZyb206ICR7dmFsdWV9YCk7XG4gICAgICBpZiAoIXRoaXMuYWxsb3dOYXZpZ2F0aW9uV2l0aG91dFJlbG9hZCAmJiAhdGhpcy5wYWdlTG9hZGluZykge1xuICAgICAgICByZXNvbHZlKHZhbHVlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy5kZWJ1ZygnRnJhbWUgbmF2aWdhdGVkIGJ1dCB3ZSB3ZXJlIHdhcm5lZCBhYm91dCBpdCwgbm90ICcgK1xuICAgICAgICAgICAgICAgICAgJ2NvbnNpZGVyaW5nIHBhZ2Ugc3RhdGUgdW5sb2FkZWQnKTtcbiAgICAgICAgdGhpcy5hbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkID0gZmFsc2U7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5uYXZpZ2F0aW9uRGVsYXkpIHtcbiAgICAgICAgdGhpcy5uYXZpZ2F0aW9uRGVsYXkuY2FuY2VsKCk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHRoaXMucnBjQ2xpZW50Lm9uY2UoJ1BhZ2UuZnJhbWVOYXZpZ2F0ZWQnLCBuYXZFdmVudExpc3RlbmVyKTtcblxuICAgIC8vIHRpbWVvdXQsIGluIGNhc2UgcmVtb3RlIGRlYnVnZ2VyIGRvZXNuJ3QgcmVzcG9uZCxcbiAgICAvLyBvciB0YWtlcyBhIGxvbmcgdGltZVxuICAgIGlmICghdGhpcy51c2VOZXdTYWZhcmkgfHwgdGhpcy5wYWdlTG9hZE1zID49IDApIHtcbiAgICAgIC8vIHVzZSBwYWdlTG9hZE1zLCBvciBhIHNtYWxsIGFtb3VudCBvZiB0aW1lXG4gICAgICBjb25zdCB0aW1lb3V0ID0gdGhpcy51c2VOZXdTYWZhcmkgPyB0aGlzLnBhZ2VMb2FkTXMgOiA1MDA7XG4gICAgICB0aGlzLm5hdmlnYXRpb25EZWxheSA9IHV0aWwuY2FuY2VsbGFibGVEZWxheSh0aW1lb3V0KTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMubmF2aWdhdGlvbkRlbGF5O1xuICAgICAgICBuYXZFdmVudExpc3RlbmVyKG51bGwsIGAke3RpbWVvdXR9bXMgdGltZW91dGApO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIC8vIG5vdGhpbmcgdG8gZG86IHdlIG9ubHkgZ2V0IGhlcmUgaWYgdGhlIHJlbW90ZSBkZWJ1Z2dlclxuICAgICAgICAvLyBhbHJlYWR5IG5vdGlmaWVkIG9mIGZyYW1lIG5hdmlnYXRpb24sIGFuZCB0aGUgZGVsYXlcbiAgICAgICAgLy8gd2FzIGNhbmNlbGxlZFxuICAgICAgfVxuICAgIH1cbiAgfSkuZmluYWxseSgoKSA9PiB7XG4gICAgaWYgKG5hdkV2ZW50TGlzdGVuZXIpIHtcbiAgICAgIHRoaXMucnBjQ2xpZW50Lm9mZignUGFnZS5mcmFtZU5hdmlnYXRlZCcsIG5hdkV2ZW50TGlzdGVuZXIpO1xuICAgIH1cbiAgfSk7XG59XG5cblxuZXhwb3J0IGRlZmF1bHQgeyBmcmFtZURldGFjaGVkLCBwYWdlTG9hZCwgY2FuY2VsUGFnZUxvYWQsIHBhZ2VVbmxvYWQsIHdhaXRGb3JEb20sIGNoZWNrUGFnZUlzUmVhZHksIG5hdlRvVXJsLCB3YWl0Rm9yRnJhbWVOYXZpZ2F0ZWQgfTtcbiJdLCJmaWxlIjoibGliL21peGlucy9uYXZpZ2F0ZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
