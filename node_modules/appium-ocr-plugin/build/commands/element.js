"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getAttribute = exports.getText = exports.getElementRect = exports.getLocation = exports.getSize = exports.elementDisplayed = exports.click = exports.ocrElementGuard = exports.OCRElement = exports.OCR_ELEMENT_PREFIX = void 0;
const support_1 = require("appium/support");
const driver_1 = require("appium/driver");
const TAP_DURATION_MS = 250;
exports.OCR_ELEMENT_PREFIX = 'ocr-element-';
class OCRElement {
    constructor(text, confidence, bbox) {
        this.text = text;
        this.confidence = confidence;
        this.rect = {
            x: bbox.x0,
            y: bbox.y0,
            width: bbox.x1 - bbox.x0,
            height: bbox.y1 - bbox.y0,
        };
        this.id = `${exports.OCR_ELEMENT_PREFIX}${support_1.util.uuidV4()}`;
    }
    get size() {
        return { width: this.rect.width, height: this.rect.height };
    }
    get location() {
        return { x: this.rect.x, y: this.rect.y };
    }
    get center() {
        return {
            x: this.rect.x + this.rect.width / 2,
            y: this.rect.y + this.rect.height / 2,
        };
    }
    get asW3CElementObject() {
        return { [support_1.util.W3C_WEB_ELEMENT_IDENTIFIER]: this.id };
    }
}
exports.OCRElement = OCRElement;
function ocrElementGuard(next, elId, fn) {
    return __awaiter(this, void 0, void 0, function* () {
        return yield this.ocrContextGuard(next, () => __awaiter(this, void 0, void 0, function* () {
            const el = this.ocrElements[elId];
            if (!el) {
                throw new driver_1.errors.NoSuchElementError();
            }
            return yield fn(el);
        }));
    });
}
exports.ocrElementGuard = ocrElementGuard;
function click(next, driver, elId) {
    return __awaiter(this, void 0, void 0, function* () {
        return yield this.ocrElementGuard(next, elId, (el) => __awaiter(this, void 0, void 0, function* () {
            const { x, y } = el.center;
            this.logger.info(`Will tap on image element at coordinate [${x}, ${y}]`);
            const action = {
                type: 'pointer',
                id: 'mouse',
                parameters: { pointerType: 'touch' },
                actions: [
                    { type: 'pointerMove', x, y, duration: 0 },
                    { type: 'pointerDown', button: 0 },
                    { type: 'pause', duration: TAP_DURATION_MS },
                    { type: 'pointerUp', button: 0 },
                ]
            };
            // check if the driver has the appropriate performActions method
            if (driver.performActions) {
                return yield driver.performActions([action]);
            }
            throw new Error("Driver did not implement the 'performActions' command");
        }));
    });
}
exports.click = click;
function elementDisplayed(next, _, elId) {
    return __awaiter(this, void 0, void 0, function* () {
        return yield this.ocrElementGuard(next, elId, () => __awaiter(this, void 0, void 0, function* () { return true; }));
    });
}
exports.elementDisplayed = elementDisplayed;
function getSize(next, _, elId) {
    return __awaiter(this, void 0, void 0, function* () {
        return yield this.ocrElementGuard(next, elId, (el) => __awaiter(this, void 0, void 0, function* () { return el.size; }));
    });
}
exports.getSize = getSize;
function getLocation(next, _, elId) {
    return __awaiter(this, void 0, void 0, function* () {
        return yield this.ocrElementGuard(next, elId, (el) => __awaiter(this, void 0, void 0, function* () { return el.location; }));
    });
}
exports.getLocation = getLocation;
function getElementRect(next, _, elId) {
    return __awaiter(this, void 0, void 0, function* () {
        return yield this.ocrElementGuard(next, elId, (el) => __awaiter(this, void 0, void 0, function* () { return el.rect; }));
    });
}
exports.getElementRect = getElementRect;
function getText(next, _, elId) {
    return __awaiter(this, void 0, void 0, function* () {
        return yield this.ocrElementGuard(next, elId, (el) => __awaiter(this, void 0, void 0, function* () { return el.text; }));
    });
}
exports.getText = getText;
function getAttribute(next, _, attr, elId) {
    return __awaiter(this, void 0, void 0, function* () {
        return yield this.ocrElementGuard(next, elId, (el) => __awaiter(this, void 0, void 0, function* () {
            if (attr !== 'confidence') {
                throw new Error(`Unsupported OCR element attribute '${attr}'`);
            }
            return el.confidence;
        }));
    });
}
exports.getAttribute = getAttribute;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWxlbWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21tYW5kcy9lbGVtZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUVBLDRDQUFxQztBQUVyQywwQ0FBdUM7QUFhdkMsTUFBTSxlQUFlLEdBQUcsR0FBRyxDQUFBO0FBQ2QsUUFBQSxrQkFBa0IsR0FBRyxjQUFjLENBQUE7QUFFaEQsTUFBYSxVQUFVO0lBT25CLFlBQVksSUFBWSxFQUFFLFVBQWtCLEVBQUUsSUFBVTtRQUNwRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQTtRQUNoQixJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQTtRQUM1QixJQUFJLENBQUMsSUFBSSxHQUFHO1lBQ1IsQ0FBQyxFQUFFLElBQUksQ0FBQyxFQUFFO1lBQ1YsQ0FBQyxFQUFFLElBQUksQ0FBQyxFQUFFO1lBQ1YsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEVBQUU7WUFDeEIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEVBQUU7U0FDNUIsQ0FBQTtRQUNELElBQUksQ0FBQyxFQUFFLEdBQUcsR0FBRywwQkFBa0IsR0FBRyxjQUFJLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQTtJQUNyRCxDQUFDO0lBRUQsSUFBSSxJQUFJO1FBQ0osT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQTtJQUMvRCxDQUFDO0lBRUQsSUFBSSxRQUFRO1FBQ1IsT0FBTyxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQTtJQUM3QyxDQUFDO0lBRUQsSUFBSSxNQUFNO1FBQ04sT0FBTztZ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