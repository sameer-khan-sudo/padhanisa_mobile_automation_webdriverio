"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.setContext = exports.getCurrentContext = exports.getContexts = exports.shouldAvoidProxy = void 0;
const __1 = require("..");
function shouldAvoidProxy(_, route) {
    if (this.isInOcrContext) {
        return true;
    }
    if (route.match(/\/contexts?$/)) {
        return true;
    }
    return false;
}
exports.shouldAvoidProxy = shouldAvoidProxy;
function getContexts(next) {
    return __awaiter(this, void 0, void 0, function* () {
        let existingContexts = [];
        try {
            existingContexts = yield next();
        }
        catch (err) {
            this.logger.info(`Default behavior failed handling getContexts, ignoring`);
            this.logger.info(`Original error: ${err}`);
        }
        return [...existingContexts, __1.OCR_CONTEXT];
    });
}
exports.getContexts = getContexts;
function getCurrentContext(next) {
    return __awaiter(this, void 0, void 0, function* () {
        if (this.isInOcrContext) {
            return __1.OCR_CONTEXT;
        }
        try {
            return yield next();
        }
        catch (err) {
            this.logger.info(`Default behavior failed handling getContext, ignoring`);
            this.logger.info(`Original error: ${err}`);
            return null;
        }
    });
}
exports.getCurrentContext = getCurrentContext;
function setContext(next, name) {
    return __awaiter(this, void 0, void 0, function* () {
        if (name !== __1.OCR_CONTEXT) {
            this.isInOcrContext = false;
            try {
                return yield next();
            }
            catch (err) {
                this.logger.info(`Default behavior failed handling setContext, ignoring`);
                this.logger.info(`Original error: ${err}`);
            }
        }
        this.isInOcrContext = true;
    });
}
exports.setContext = setContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21tYW5kcy9jb250ZXh0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLDBCQUE4RDtBQUU5RCxTQUFnQixnQkFBZ0IsQ0FBd0IsQ0FBUyxFQUFFLEtBQWE7SUFDNUUsSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFO1FBQ3JCLE9BQU8sSUFBSSxDQUFBO0tBQ2Q7SUFDRCxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLEVBQUU7UUFDN0IsT0FBTyxJQUFJLENBQUE7S0FDZDtJQUNELE9BQU8sS0FBSyxDQUFBO0FBQ2hCLENBQUM7QUFSRCw0Q0FRQztBQUVELFNBQXNCLFdBQVcsQ0FBd0IsSUFBaUI7O1FBQ3RFLElBQUksZ0JBQWdCLEdBQUcsRUFBRSxDQUFBO1FBQ3pCLElBQUk7WUFDQSxnQkFBZ0IsR0FBRyxNQUFNLElBQUksRUFBRSxDQUFBO1NBQ2xDO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDVixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyx3REFBd0QsQ0FBQyxDQUFBO1lBQzFFLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLEVBQUUsQ0FBQyxDQUFBO1NBQzdDO1FBQ0QsT0FBTyxDQUFDLEdBQUcsZ0JBQWdCLEVBQUUsZUFBVyxDQUFDLENBQUE7SUFDN0MsQ0FBQztDQUFBO0FBVEQsa0NBU0M7QUFFRCxTQUFzQixpQkFBaUIsQ0FBd0IsSUFBaUI7O1FBQzVFLElBQUksSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUNyQixPQUFPLGVBQVcsQ0FBQTtTQUNyQjtRQUNELElBQUk7WUFDQSxPQUFPLE1BQU0sSUFBSSxFQUFFLENBQUE7U0FDdEI7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNWLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLHVEQUF1RCxDQUFDLENBQUE7WUFDekUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsRUFBRSxDQUFDLENBQUE7WUFDMUMsT0FBTyxJQUFJLENBQUE7U0FDZDtJQUNMLENBQUM7Q0FBQTtBQVhELDhDQVdDO0FBRUQsU0FBc0IsVUFBVSxDQUF3QixJQUFpQixFQUFFLElBQVk7O1FBQ25GLElBQUksSUFBSSxLQUFLLGVBQVcsRUFBRTtZQUN0QixJQUFJLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQTtZQUMzQixJQUFJO2dCQUNBLE9BQU8sTUFBTSxJQUFJLEVBQUUsQ0FBQTthQUN0QjtZQUFDLE9BQU8sR0FBRyxFQUFFO2dCQUNWLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLHVEQUF1RCxDQUFDLENBQUE7Z0JBQ3pFLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLEVBQUUsQ0FBQyxDQUFBO2FBQzdDO1NBQ0o7UUFDRCxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQTtJQUM5QixDQUFDO0NBQUE7QUFYRCxnQ0FXQyJ9