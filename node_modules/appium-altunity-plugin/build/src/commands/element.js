"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getProperty = exports.getAttribute = exports.getText = exports.getElementRect = exports.getLocation = exports.elementDisplayed = exports.click = exports.unityElementGuard = exports.UnityElement = exports.ALL_COMPONENTS_PROP = exports.UNITY_ELEMENT_PREFIX = void 0;
const support_1 = require("appium/support");
const driver_1 = require("appium/driver");
const alt_element_1 = require("../client/alt-element");
exports.UNITY_ELEMENT_PREFIX = 'unity-element-';
exports.ALL_COMPONENTS_PROP = '*';
const COMPONENT_PROPERTY_RE = /(.+):(.+)/;
class UnityElement {
    constructor(element) {
        this.element = element;
        this.id = `${exports.UNITY_ELEMENT_PREFIX}${element.id}`;
    }
    get location() {
        return { x: this.element.x, y: this.element.y };
    }
    get asW3CElementObject() {
        return { [support_1.util.W3C_WEB_ELEMENT_IDENTIFIER]: this.id };
    }
}
exports.UnityElement = UnityElement;
async function unityElementGuard(next, elId, fn) {
    return await this.unityContextGuard(next, async () => {
        const el = this.unityElements[elId];
        if (!el) {
            throw new driver_1.errors.NoSuchElementError(undefined);
        }
        return await fn(el);
    });
}
exports.unityElementGuard = unityElementGuard;
async function click(next, driver, elId) {
    return await this.unityElementGuard(next, elId, async (el) => await el.element.tapViaCoords());
}
exports.click = click;
async function elementDisplayed(next, driver, elId) {
    return await this.unityElementGuard(next, elId, async (el) => {
        const { width, height } = await this.getCachedScreenDims(driver);
        const { x, y } = el.element.asUnityObject();
        return x >= 0 && x <= width && y >= 0 && y <= height;
    });
}
exports.elementDisplayed = elementDisplayed;
async function getLocation(next, _, elId) {
    return await this.unityElementGuard(next, elId, async (el) => el.location);
}
exports.getLocation = getLocation;
async function getElementRect(next, _, elId) {
    // just report 0 for width and height since we don't know them
    return await this.unityElementGuard(next, elId, async (el) => ({ ...el.location, width: 0, height: 0 }));
}
exports.getElementRect = getElementRect;
async function getText(next, _, elId) {
    return await this.unityElementGuard(next, elId, async (el) => {
        try {
            return await el.element.getText();
        }
        catch (err) {
            if (err.message.includes('Component TMP_InputField')) {
                return null;
            }
            throw err;
        }
    });
}
exports.getText = getText;
async function getAttribute(next, _, attr, elId) {
    return await this.unityElementGuard(next, elId, async (el) => {
        if (!alt_element_1.ALT_ELEMENT_KEYS.includes(attr)) {
            throw new Error(`Cannot get '${attr}' attribute from element`);
        }
        const data = el.element.asUnityObject();
        return data[attr];
    });
}
exports.getAttribute = getAttribute;
async function getProperty(next, _, prop, elId) {
    return await this.unityElementGuard(next, elId, async (el) => {
        // then check if it's of the form 'component:property' to return a component prop directly
        const componentMatch = COMPONENT_PROPERTY_RE.exec(prop);
        if (componentMatch) {
            const [, component, property] = componentMatch;
            return JSON.stringify(await el.element.getComponentProperty(component, property, ''));
        }
        const allComponents = await el.element.getComponents();
        // otherwise if it's the magic '*', return all components
        if (prop === exports.ALL_COMPONENTS_PROP) {
            return JSON.stringify(allComponents.map((c) => c.toObject()));
        }
        // otherwise it must be the name of a component to return
        const components = allComponents.filter((c) => c.name === prop);
        if (!components[0]) {
            throw new Error(`Element had no component named '${prop}'`);
        }
        return JSON.stringify(components[0].toObject());
    });
}
exports.getProperty = getProperty;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWxlbWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21tYW5kcy9lbGVtZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLDRDQUFxQztBQUNyQywwQ0FBa0Q7QUFFbEQsdURBQXdFO0FBSTNELFFBQUEsb0JBQW9CLEdBQUcsZ0JBQWdCLENBQUE7QUFDdkMsUUFBQSxtQkFBbUIsR0FBRyxHQUFHLENBQUE7QUFDdEMsTUFBTSxxQkFBcUIsR0FBRyxXQUFXLENBQUE7QUFFekMsTUFBYSxZQUFZO0lBS3JCLFlBQVksT0FBbUI7UUFDM0IsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUE7UUFDdEIsSUFBSSxDQUFDLEVBQUUsR0FBRyxHQUFHLDRCQUFvQixHQUFHLE9BQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQTtJQUNwRCxDQUFDO0lBRUQsSUFBSSxRQUFRO1FBQ1IsT0FBTyxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQTtJQUNuRCxDQUFDO0lBRUQsSUFBSSxrQkFBa0I7UUFDbEIsT0FBTyxFQUFDLENBQUMsY0FBSSxDQUFDLDBCQUEwQixDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBQyxDQUFBO0lBQ3ZELENBQUM7Q0FDSjtBQWpCRCxvQ0FpQkM7QUFFTSxLQUFLLFVBQVUsaUJBQWlCLENBQXVCLElBQWlCLEVBQUUsSUFBWSxFQUN2RCxFQUFzQztJQUN4RSxPQUFPLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksRUFBRSxLQUFLLElBQUksRUFBRTtRQUNqRCxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ25DLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDTCxNQUFNLElBQUksZUFBTSxDQUFDLGtCQUFrQixDQUFDLFNBQVMsQ0FB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