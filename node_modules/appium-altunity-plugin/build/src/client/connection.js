"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Connection = exports.NotificationHandler = exports.ResponseValidationError = exports.CommandTimeoutError = exports.NoConnectionError = exports.NotificationType = void 0;
const events_1 = require("events");
const lodash_1 = require("lodash");
const ws_1 = __importDefault(require("ws"));
const bluebird_1 = __importDefault(require("bluebird"));
bluebird_1.default.config({
    cancellation: true
});
const TRUNCATE_LEN = 300;
var NotificationType;
(function (NotificationType) {
    NotificationType["LOAD_SCENE"] = "LOAD_SCENE";
    NotificationType["UNLOAD_SCENE"] = "UNLOAD_SCENE";
    NotificationType["LOG"] = "LOG";
    NotificationType["APP_PAUSED"] = "APP_PAUSED";
})(NotificationType = exports.NotificationType || (exports.NotificationType = {}));
class NoConnectionError extends Error {
    constructor() {
        super(`There is no websocket connection active`);
    }
}
exports.NoConnectionError = NoConnectionError;
class CommandTimeoutError extends Error {
    constructor(msgId, timeout) {
        super(`Message with id ${msgId} timed out after ${timeout}s`);
    }
}
exports.CommandTimeoutError = CommandTimeoutError;
class ResponseValidationError extends Error {
    constructor(msgId, resIdx, expected, actual) {
        super(`Could not validate response for message ${msgId}, response #${resIdx + 1} in sequence: ` +
            `We expected the data to be '${expected}' but it was '${actual}'`);
    }
}
exports.ResponseValidationError = ResponseValidationError;
class NotificationHandler extends events_1.EventEmitter {
    handle(message) {
        const data = JSON.parse(message.data);
        let eventType;
        let result = data;
        switch (message.commandName) {
            case 'loadSceneNotification':
                eventType = NotificationType.LOAD_SCENE;
                break;
            case 'unloadSceneNotification':
                eventType = NotificationType.UNLOAD_SCENE;
                break;
            case 'logNotification':
                eventType = NotificationType.LOG;
                break;
            case 'applicationPausedNotification':
                eventType = NotificationType.APP_PAUSED;
                result = !!data;
            default:
                throw new Error(`Received a notification of type '${message.commandName}' but ` +
                    `didn't know how to handle it`);
        }
        this.emit(eventType, result);
    }
}
exports.NotificationHandler = NotificationHandler;
class Connection {
    constructor(opts) {
        this.ws = null;
        this.notificationHandler = new NotificationHandler();
        this.messageCallbacks = {};
        this.responseStore = {};
        this.closeCallback = null;
        this._commandTimeoutSecs = 5;
        this.log = opts.log;
        this.host = opts.host;
        this.port = opts.port;
        if (opts.commandTimeout) {
            this.commandTimeout = opts.commandTimeout;
        }
    }
    get commandTimeout() {
        return this._commandTimeoutSecs;
    }
    set commandTimeout(secs) {
        this._commandTimeoutSecs = secs;
    }
    async connect() {
        const wsUrl = `ws://${this.host}:${this.port}/altws/`;
        this.log.info(`Initiating websocket connection to ${wsUrl}`);
        return await new Promise((res, rej) => {
            this.ws = new ws_1.default(wsUrl);
            this.ws.on('message', this.handleIncomingMessage.bind(this));
            this.ws.on('close', this.handleClose.bind(this));
            this.ws.on('error', rej);
            this.ws.on('open', res);
        });
    }
    async handleIncomingMessage(jsonMessage) {
        const response = JSON.parse(jsonMessage.toString('utf8'));
        this.log.info(`Received response for message ${response.messageId}`);
        this.log.debug((0, lodash_1.truncate)(JSON.stringify(response), { length: TRUNCATE_LEN }));
        if (response.isNotification) {
            this.notificationHandler.handle(response);
            return;
        }
        if (!Object.keys(this.messageCallbacks).includes(response.messageId)) {
            this.log.warn(`Received message with id '${response.messageId}' when we ` +
                `weren't expecting one, maybe it timed out?; ignoring. ` +
                `Message data:`);
            this.log.warn(jsonMessage.toString('utf8'));
            return;
        }
        const callback = this.messageCallbacks[response.messageId];
        try {
            // if anything goes wrong in here, we still want to unset the timer
            // the 'data' field is itself stringified, so turn it back
            response.data = JSON.parse(response.data);
            if (!this.responseStore[response.messageId]) {
                this.responseStore[response.messageId] = [];
            }
            const store = this.responseStore[response.messageId];
            const msgProcessingIdx = store.length;
            // check if we should do validations on the response for the current response in the
            // response sequences
            const expectedData = callback.validations[msgProcessingIdx];
            if (typeof expectedData !== 'undefined' && expectedData !== response.data) {
                throw new ResponseValidationError(response.messageId, msgProcessingIdx, expectedData, response.data);
            }
            // if we've passed validation, add the response to the sequence
            store.push(response);
            // if we've reached the end of our sequence, wrap everything up and return it via the
            // callback
            if (store.length === callback.responseCount) {
                callback.cb(store);
                delete this.messageCallbacks[response.messageId];
                delete this.responseStore[response.messageId];
            }
            // otherwise do nothing and wait for the next response in the sequence
        }
        finally {
            // whether or not we've successfully replied, make sure to end the timer
            callback.timerPromise.cancel();
        }
    }
    async handleClose() {
        this.ws = null;
        if (this.closeCallback) {
            this.closeCallback();
            this.closeCallback = null;
            return;
        }
        this.log.error(`Websocket connection was closed when we did not expect`);
    }
    async sendMessage(message, responseCount = 1, validations = []) {
        this.log.info(`Sending message ${message.messageId} with command ${message.commandName}`);
        this.log.debug((0, lodash_1.truncate)(JSON.stringify(message), { length: TRUNCATE_LEN }));
        return await new Promise(async (res, rej) => {
            try {
                if (!this.ws) {
                    throw new NoConnectionError();
                }
                const jsonMessage = JSON.stringify(message);
                const timerPromise = bluebird_1.default.delay(this._commandTimeoutSecs * 1000);
                // set a handler keyed on message id
                this.messageCallbacks[message.messageId] = { responseCount, validations, cb: res, timerPromise };
                this.ws.send(jsonMessage);
                // now wait for our command timeout
                await timerPromise;
                // if we get here and the response handler has not already been removed, that means
                // we timed out, so throw an error
                if (this.messageCallbacks[message.messageId]) {
                    delete this.messageCallbacks[message.messageId];
                    throw new CommandTimeoutError(message.messageId, this._commandTimeoutSecs);
                }
            }
            catch (err) {
                rej(err);
            }
        });
    }
    async sendSimpleMessage(message, validation) {
        let responses;
        if (typeof validation === 'string') {
            responses = await this.sendMessage(message, 1, [validation]);
        }
        else {
            responses = await this.sendMessage(message, 1);
        }
        return responses[0];
    }
    async close() {
        this.log.info(`Closing the websocket connection`);
        await new Promise((res) => {
            if (!this.ws) {
                throw new NoConnectionError();
            }
            this.closeCallback = res;
            this.ws.close();
            this.ws = null;
        });
        this.log.info(`Websocket connection is now closed`);
    }
}
exports.Connection = Connection;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jbGllbnQvY29ubmVjdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxtQ0FBcUM7QUFDckMsbUNBQWlDO0FBQ2pDLDRDQUEwQjtBQUMxQix3REFBd0I7QUFFeEIsa0JBQUMsQ0FBQyxNQUFNLENBQUM7SUFDTCxZQUFZLEVBQUUsSUFBSTtDQUNyQixDQUFDLENBQUE7QUFFRixNQUFNLFlBQVksR0FBRyxHQUFHLENBQUE7QUFFeEIsSUFBWSxnQkFLWDtBQUxELFdBQVksZ0JBQWdCO0lBQ3hCLDZDQUF5QixDQUFBO0lBQ3pCLGlEQUE2QixDQUFBO0lBQzdCLCtCQUFXLENBQUE7SUFDWCw2Q0FBeUIsQ0FBQTtBQUM3QixDQUFDLEVBTFcsZ0JBQWdCLEdBQWhCLHdCQUFnQixLQUFoQix3QkFBZ0IsUUFLM0I7QUF5Q0QsTUFBYSxpQkFBa0IsU0FBUSxLQUFLO0lBQ3hDO1FBQ0ksS0FBSyxDQUFDLHlDQUF5QyxDQUFDLENBQUE7SUFDcEQsQ0FBQztDQUNKO0FBSkQsOENBSUM7QUFFRCxNQUFhLG1CQUFvQixTQUFRLEtBQUs7SUFDMUMsWUFBWSxLQUFhLEVBQUUsT0FBZTtRQUN0QyxLQUFLLENBQUMsbUJBQW1CLEtBQUssb0JBQW9CLE9BQU8sR0FBRyxDQUFDLENBQUE7SUFDakUsQ0FBQztDQUNKO0FBSkQsa0RBSUM7QUFFRCxNQUFhLHVCQUF3QixTQUFRLEtBQUs7SUFDOUMsWUFBWSxLQUFhLEVBQUUsTUFBYyxFQUFFLFFBQWEsRUFBRSxNQUFXO1FBQ2pFLEtBQUssQ0FBQywyQ0FBMkMsS0FBSyxlQUFlLE1BQU0sR0FBRyxDQUFDLGdCQUFnQjtZQUN6RiwrQkFBK0IsUUFBUSxpQkFBaUIsTUFBTSxHQUFHLENBQUMsQ0FBQTtJQUM1RSxDQUFDO0NBQ0o7QUFMRCwwREFLQztBQUVELE1BQWEsbUJBQW9CLFNBQVEscUJBQVk7SUFFakQsTUFBTSxD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