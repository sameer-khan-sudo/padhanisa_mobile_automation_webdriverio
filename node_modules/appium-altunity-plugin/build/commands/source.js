"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getPageSource = void 0;
const xml_js_1 = __importDefault(require("xml-js"));
const element_1 = require("./element");
function hierarchyElementToXmlJs(element) {
    return {
        type: 'element',
        name: element.element.name.replace(/[^a-zA-Z0-9_\-\.]/g, '_'),
        attributes: { ...element.element.asUnityObject() },
        elements: element.children.map(hierarchyElementToXmlJs)
    };
}
function hierarchyToXmlJs(hierarchy) {
    return {
        elements: [{
                type: 'element',
                name: 'Unity',
                elements: hierarchy.map(hierarchyElementToXmlJs)
            }]
    };
}
async function getPageSource(next) {
    return await this.unityContextGuard(next, async () => {
        const allEls = await this.client.findAllObjects();
        // pre-emptively add all the elements we find in the cache
        for (const el of allEls) {
            const unityEl = new element_1.UnityElement(el);
            this.unityElements[unityEl.id] = unityEl;
        }
        const hierarchy = await this.client.getHierarchy(allEls);
        const hierarchyJs = hierarchyToXmlJs(hierarchy);
        return xml_js_1.default.js2xml(hierarchyJs, { spaces: 4 });
    });
}
exports.getPageSource = getPageSource;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic291cmNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NvbW1hbmRzL3NvdXJjZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFHQSxvREFBMEI7QUFDMUIsdUNBQXdDO0FBYXhDLFNBQVMsdUJBQXVCLENBQUMsT0FBeUI7SUFDdEQsT0FBTztRQUNILElBQUksRUFBRSxTQUFTO1FBQ2YsSUFBSSxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsRUFBRSxHQUFHLENBQUM7UUFDN0QsVUFBVSxFQUFFLEVBQUMsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxFQUFDO1FBQ2hELFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsQ0FBQztLQUMxRCxDQUFBO0FBQ0wsQ0FBQztBQUVELFNBQVMsZ0JBQWdCLENBQUMsU0FBNkI7SUFDbkQsT0FBTztRQUNILFFBQVEsRUFBRSxDQUFDO2dCQUNQLElBQUksRUFBRSxTQUFTO2dCQUNmLElBQUksRUFBRSxPQUFPO2dCQUNiLFFBQVEsRUFBRSxTQUFTLENBQUMsR0FBRyxDQUFDLHVCQUF1QixDQUFDO2FBQ25ELENBQUM7S0FDTCxDQUFBO0FBQ0wsQ0FBQztBQUVNLEtBQUssVUFBVSxhQUFhLENBQXVCLElBQWlCO0lBQ3ZFLE9BQU8sTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQ2pELE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLEVBQUUsQ0FBQTtRQUVqRCwwREFBMEQ7UUFDMUQsS0FBSyxNQUFNLEVBQUUsSUFBSSxNQUFNLEVBQUU7WUFDckIsTUFBTSxPQUFPLEdBQUcsSUFBSSxzQkFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1lBQ3BDLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQTtTQUMzQztRQUNELE1BQU0sU0FBUyxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDeEQsTUFBTSxXQUFXLEdBQUcsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLENBQUE7UUFDL0MsT0FBTyxnQkFBSyxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsRUFBQyxNQUFNLEVBQUUsQ0FBQyxFQUFDLENBQUMsQ0FBQTtJQUNqRCxDQUFDLENBQUMsQ0FBQTtBQUNOLENBQUM7QUFiRCxzQ0FhQyJ9